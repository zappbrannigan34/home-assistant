views:
  - title: Humidity Control
    type: custom:grid-layout
    layout:
      grid-template-columns: 2fr 1fr
      grid-template-rows: auto
      grid-gap: 8px
      mediaquery:
        "(max-width: 800px)":
          grid-template-columns: 1fr
    cards:
      # ----------------------------------------------------------------------
      # Секция 1: График (Plotly)
      # ----------------------------------------------------------------------
      - type: custom:plotly-graph
        layout:
          height: 600
          barmode: overlay
          shapes:
            - type: line
              xref: paper
              x0: 0
              x1: 1
              yref: y2
              y0: 0
              y1: 0
              line:
                color: '#ffffff'
                width: 2
                dash: dash
          xaxis:
            rangeselector:
              "y": 1.1
              buttons:
                - count: 1
                  label: 15m
                  step: minute
                  stepmode: backward
                - count: 6
                  label: 6h
                  step: hour
                  stepmode: backward
                - count: 12
                  label: 12h
                  step: hour
                  stepmode: backward
                - count: 24
                  label: 24h
                  step: hour
                  stepmode: backward
          
          # Левая ось (Влажность)
          yaxis:
            title: Humidity (%)
            side: left
            fixedrange: true
            range: [0, 100]
            zeroline: true
            zerolinecolor: 'gray'
            zerolinewidth: 2
          
          # Правая ось (Ошибка)
          yaxis2:
            title: Error (%)
            side: right
            overlaying: "y"
            range: [-10, 10]
            showgrid: false
            zeroline: true
            zerolinecolor: '#444'
            fixedrange: true

        defaults:
          xaxes:
            fixedrange: true
          yaxes:
            fixedrange: true
            side: left
          entity:
            filters:
              - sliding_window_moving_average:
                  window_size: 2
                  relative_to_visible: true
            line:
              shape: spline
              smoothing: 1

        time_offset: 5m
        
        entities:
          # 1. Deviation (Error)
          - entity: sensor.humidity_error
            name: Deviation
            yaxis: y2
            line:
              color: '#F44336'
              width: 1
            fill: tozeroy
            fillcolor: 'rgba(244, 67, 54, 0.1)'
            connectgaps: true
            showlegend: true

          # 2. Target Humidity
          - entity: sensor.adaptive_target_humidity
            name: Target Humidity
            filters:
            yaxis: y
            line:
              color: '#FF9800'
              width: 2
              dash: dot
            connectgaps: true
            extend_to_present: true
            showlegend: true

          # 3. Current Humidity
          - entity: sensor.sensor_eva_humidity
            name: Current Humidity
            yaxis: y
            line:
              color: '#2196F3'
              width: 2
            fillcolor: 'rgba(33, 150, 243, 0.1)'
            connectgaps: true
            showlegend: true

          # 5. Water Level
          - entity: sensor.humidifier_water_level
            name: Water Level
            yaxis: y
            line:
              color: '#00BCD4'
              width: 2
              dash: dashdot
            connectgaps: true
            showlegend: true

           # 4. Current intensity - ИСПОЛЬЗУЕТ ФУНКЦИЮ ДЛЯ ТЕКУЩЕГО ЗНАЧЕНИЯ
          - entity: number.humidifier_puh_9105_puh_2709_intensity
            name: Current intensity
            yaxis: y2
            internal: false
            show_value: false
            fn: |-
              $fn ({ hass, vars }) => {
                const val = parseFloat(hass.states['number.humidifier_puh_9105_puh_2709_intensity']?.state) || 0;
                const now = new Date();
                const start = new Date(now.getTime() - 25 * 60 * 60 * 1000);
                return {
                  xs: [start, now],
                  ys: [val, val]
                };
              }
            line:
              color: '#f436d4ff'
              width: 2
              shape: hv
            fill: tozeroy
            fillcolor: 'rgba(244, 54, 244, 0.2)'
            showlegend: true

        hours_to_show: 0.25  # ИСПРАВЛЕНО: 15 минут = 0.25 часа (число!)
        refresh_interval: 10
        autorange_after_scroll: true
        disable_pinch_to_zoom: true
        
        view_layout:
          grid-area: 1 / 1 / span 3 / 2

      # ----------------------------------------------------------------------
      # Секция 2: Правая колонка
      # ----------------------------------------------------------------------
      - type: grid
        columns: 3
        square: false
        cards:
          - type: gauge
            entity: sensor.sensor_eva_humidity
            name: Current
            min: 0
            max: 100
            segments:
              - from: 0
                color: '#db4437'
              - from: 20
                color: '#f4b400'
              - from: 30
                color: '#43a047'
              - from: 60
                color: '#f4b400'
              - from: 70
                color: '#db4437'
            needle: true

          - type: gauge
            entity: sensor.adaptive_target_humidity
            name: Target
            min: 0
            max: 100
            needle: true
            severity:
              green: 30
              yellow: 0
              red: 0

          - type: gauge
            entity: sensor.humidifier_water_level
            name: Water
            unit: "%"
            min: 0
            max: 100
            segments:
              - from: 0
                color: '#db4437'
              - from: 10
                color: '#f4b400'
              - from: 25
                color: '#43a047'
            needle: true
        view_layout:
          grid-area: 1 / 2 / 2 / 3

      - type: entities
        title: Diagnostics
        show_header_toggle: false
        state_color: true
        entities:
          - entity: sensor.sensor_eva_temperature
            name: Room Temp
          - entity: weather.forecast_home_assistant
            attribute: temperature
            name: Outdoor Temp
            icon: mdi:thermometer
          
          - type: divider
          
          - entity: sensor.humidity_error
            name: Error (Target - Current)
          - entity: sensor.recommended_intensity
            name: Recommended Intensity
            icon: mdi:gauge

          - type: divider
          
          - entity: sensor.humidifier_water_level
            name: Water Level
            icon: mdi:water-percent
          - type: attribute
            entity: sensor.humidifier_water_level
            attribute: hours_remaining
            name: Time Remaining (h)
            icon: mdi:clock-outline
            suffix: h
          - entity: binary_sensor.humidifier_puh_9105_puh_2709_water_tank
            name: Water Tank Empty
          - entity: sensor.humidifier_puh_9105_puh_2709_error
            name: Error Code
          
          - type: divider
          
          - entity: humidifier.humidifier_puh_9105_puh_2709_humidifier
            name: Device Mode
          - entity: number.humidifier_puh_9105_puh_2709_intensity
            name: Fan Speed

          - type: divider

          - entity: input_text.humidifier_consumption_rates
            name: Calibrated Rates (ml/h)
            icon: mdi:tune-vertical
          - entity: input_text.humidifier_level_minutes
            name: Minutes This Cycle
            icon: mdi:timer-outline
          - entity: input_number.humidifier_calibration_cycles
            name: Calibration Cycles
        view_layout:
          grid-area: 2 / 2 / 3 / 3
