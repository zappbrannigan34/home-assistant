views:
  - title: Humidity Control
    type: custom:grid-layout
    layout:
      grid-template-columns: 2fr 1fr
      grid-template-rows: auto
      grid-gap: 8px
      mediaquery:
        "(max-width: 800px)":
          grid-template-columns: 1fr
    cards:
      # ----------------------------------------------------------------------
      # Секция 1: График (Plotly)
      # ----------------------------------------------------------------------
      - type: custom:plotly-graph
        # ENTITIES FIRST — $fn stores vars that layout reads
        entities:
          # 1. Current Humidity (y1) — stores min/max in vars
          - entity: sensor.sensor_eva_humidity
            name: Humidity
            yaxis: y
            filters:
              - sliding_window_moving_average:
                  window_size: 2
                  relative_to_visible: true
              - fn: |-
                  ({ys, vars}) => {
                    const nums = ys.filter(v => v !== null && !isNaN(+v)).map(Number);
                    if (nums.length > 0) {
                      vars.hum_min = Math.min(...nums);
                      vars.hum_max = Math.max(...nums);
                    } else {
                      vars.hum_min = 30;
                      vars.hum_max = 50;
                    }
                    return null;
                  }
            line:
              color: '#2196F3'
              width: 2
              shape: spline
              smoothing: 1
            connectgaps: true
            showlegend: true

          # 2. Error (y2) — stores min/max in vars
          - entity: sensor.humidity_error
            name: Error
            yaxis: y2
            filters:
              - sliding_window_moving_average:
                  window_size: 2
                  relative_to_visible: true
              - fn: |-
                  ({ys, vars}) => {
                    const nums = ys.filter(v => v !== null && !isNaN(+v)).map(Number);
                    if (nums.length > 0) {
                      vars.err_min = Math.min(...nums);
                      vars.err_max = Math.max(...nums);
                    } else {
                      vars.err_min = -5;
                      vars.err_max = 5;
                    }
                    return null;
                  }
            line:
              color: '#F44336'
              width: 1
              shape: spline
              smoothing: 1
            connectgaps: true
            showlegend: true

          # 3. Intensity (y3) — step line
          - entity: number.humidifier_puh_9105_puh_2709_intensity
            name: Intensity
            yaxis: y3
            line:
              color: '#AB47BC'
              width: 2
              shape: hv
            connectgaps: true
            showlegend: true

        # LAYOUT — reads vars set by entities above
        layout:
          height: 600
          shapes:
            # Target humidity line on y1
            - type: line
              xref: paper
              x0: 0
              x1: 1
              yref: y
              y0: $ex parseFloat(hass.states['sensor.adaptive_target_humidity']?.state) || 40
              y1: $ex parseFloat(hass.states['sensor.adaptive_target_humidity']?.state) || 40
              line:
                color: '#FF9800'
                width: 2
                dash: dot
            # Zero error line on y2
            - type: line
              xref: paper
              x0: 0
              x1: 1
              yref: y2
              y0: 0
              y1: 0
              line:
                color: '#ffffff'
                width: 1
                dash: dash
          xaxis:
            rangeselector:
              "y": 1.1
              buttons:
                - count: 1
                  label: 15m
                  step: minute
                  stepmode: backward
                - count: 6
                  label: 6h
                  step: hour
                  stepmode: backward
                - count: 12
                  label: 12h
                  step: hour
                  stepmode: backward
                - count: 24
                  label: 24h
                  step: hour
                  stepmode: backward

          # y1: Humidity (absolute %) — dynamic range, target aligned
          yaxis:
            title: Humidity (%)
            side: left
            fixedrange: true
            range: |-
              $fn ({vars, hass}) => {
                const hMin = vars.hum_min ?? 30;
                const hMax = vars.hum_max ?? 50;
                const pad = Math.max((hMax - hMin) * 0.1, 0.5);
                return [hMin - pad, hMax + pad];
              }

          # y2: Error (%) — dynamic range, 0 aligned with target on y1
          yaxis2:
            title: Error (%)
            side: right
            overlaying: "y"
            showgrid: false
            fixedrange: true
            range: |-
              $fn ({vars, hass}) => {
                const hMin = vars.hum_min ?? 30;
                const hMax = vars.hum_max ?? 50;
                const pad = Math.max((hMax - hMin) * 0.1, 0.5);
                const y1min = hMin - pad;
                const y1max = hMax + pad;
                const target = parseFloat(hass.states['sensor.adaptive_target_humidity']?.state) || 40;
                const f = (target - y1min) / (y1max - y1min);
                const fSafe = Math.max(0.1, Math.min(0.9, f));
                const eMin = vars.err_min ?? -5;
                const eMax = vars.err_max ?? 5;
                const S = Math.max(
                  (eMax > 0 ? eMax / (1 - fSafe) : 0),
                  (eMin < 0 ? -eMin / fSafe : 0)
                ) * 1.1;
                const Sfinal = Math.max(S, 1);
                return [-fSafe * Sfinal, (1 - fSafe) * Sfinal];
              }

          # y3: Intensity (0-7) — hidden axis
          yaxis3:
            visible: false
            overlaying: "y"
            fixedrange: true
            range: [-0.5, 8]

        defaults:
          xaxes:
            fixedrange: true
          yaxes:
            fixedrange: true

        time_offset: 5m
        hours_to_show: 0.25
        refresh_interval: 10
        autorange_after_scroll: true
        disable_pinch_to_zoom: true

        view_layout:
          grid-area: 1 / 1 / span 3 / 2

      # ----------------------------------------------------------------------
      # Секция 2: Правая колонка
      # ----------------------------------------------------------------------
      - type: grid
        columns: 3
        square: false
        cards:
          - type: gauge
            entity: sensor.sensor_eva_humidity
            name: Current
            min: 0
            max: 100
            segments:
              - from: 0
                color: '#db4437'
              - from: 20
                color: '#f4b400'
              - from: 30
                color: '#43a047'
              - from: 60
                color: '#f4b400'
              - from: 70
                color: '#db4437'
            needle: true

          - type: gauge
            entity: sensor.adaptive_target_humidity
            name: Target
            min: 0
            max: 100
            needle: true
            severity:
              green: 30
              yellow: 0
              red: 0

          - type: gauge
            entity: sensor.humidifier_water_level
            name: Water
            unit: "%"
            min: 0
            max: 100
            segments:
              - from: 0
                color: '#db4437'
              - from: 10
                color: '#f4b400'
              - from: 25
                color: '#43a047'
            needle: true
        view_layout:
          grid-area: 1 / 2 / 2 / 3

      - type: entities
        title: Diagnostics
        show_header_toggle: false
        state_color: true
        entities:
          - entity: sensor.sensor_eva_temperature
            name: Room Temp
          - entity: weather.forecast_home_assistant
            attribute: temperature
            name: Outdoor Temp
            icon: mdi:thermometer
          
          - type: divider
          
          - entity: sensor.humidity_error
            name: Error
          - entity: sensor.recommended_intensity
            name: Recommended Intensity
            icon: mdi:gauge
          - entity: number.humidifier_puh_9105_puh_2709_intensity
            name: Intensity
            icon: mdi:fan

          - type: divider
          
          - entity: sensor.humidifier_water_level
            name: Water Level
            icon: mdi:water-percent
          - type: attribute
            entity: sensor.humidifier_water_level
            attribute: hours_remaining
            name: Time Remaining (h)
            icon: mdi:clock-outline
            suffix: h
          - entity: binary_sensor.humidifier_puh_9105_puh_2709_water_tank
            name: Water Tank Empty
          - entity: sensor.humidifier_puh_9105_puh_2709_error
            name: Error Code
          
          - type: divider
          
          - entity: humidifier.humidifier_puh_9105_puh_2709_humidifier
            name: Device Mode

          - type: divider

          - entity: input_text.humidifier_consumption_rates
            name: Calibrated Rates (ml/h)
            icon: mdi:tune-vertical
          - entity: input_datetime.humidifier_cycle_start
            name: Cycle Start
            icon: mdi:timer-outline
          - entity: input_number.humidifier_calibration_cycles
            name: Calibration Cycles
        view_layout:
          grid-area: 2 / 2 / 3 / 3
