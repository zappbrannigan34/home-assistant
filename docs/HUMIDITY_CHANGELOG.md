# Humidity Control Automation - Changelog

–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–≤–ª–∞–∂–Ω–∏—Ç–µ–ª–µ–º.

**Repository:** https://github.com/zappbrannigan34/home-assistant.git  
**File:** YAML‚Äë–ø–∞–∫–µ—Ç —É–≤–ª–∞–∂–Ω–∏—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä `packages/humidity/humidity_control.yaml`)

---

## v3.1 ‚Äì PER-LEVEL CONSUMPTION RATE CALIBRATION (2026-01-29)

**Version:** 3.1.0

### –ò–∑–º–µ–Ω–µ–Ω–∏—è

#### 1. –ê–≤—Ç–æ–∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ä–∞—Å—Ö–æ–¥–∞ per-level (–≤–º–µ—Å—Ç–æ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ —ë–º–∫–æ—Å—Ç–∏ –±–∞–∫–∞)

**–ë—ã–ª–æ:** –∫–∞–ª–∏–±—Ä–æ–≤–∞–ª–∞—Å—å —ë–º–∫–æ—Å—Ç—å –±–∞–∫–∞ (–∫–æ—Å—Ç—ã–ª—å ‚Äî –±–∞–∫ –Ω–µ —Ä–µ–∑–∏–Ω–æ–≤—ã–π, –≤—Å–µ–≥–¥–∞ 5000 –º–ª).  
**–°—Ç–∞–ª–æ:** —ë–º–∫–æ—Å—Ç—å –±–∞–∫–∞ = –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞. –ö–∞–ª–∏–±—Ä—É—é—Ç—Å—è **—Å—Ç–∞–≤–∫–∏ —Ä–∞—Å—Ö–æ–¥–∞** (–º–ª/—á) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑ 7 —É—Ä–æ–≤–Ω–µ–π –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏.

- `input_text.humidifier_consumption_rates` ‚Äî JSON —Å –∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Å—Ç–∞–≤–∫–∞–º–∏
- `input_text.humidifier_level_minutes` ‚Äî JSON-—Å—á—ë—Ç—á–∏–∫ –º–∏–Ω—É—Ç —Ä–∞–±–æ—Ç—ã –Ω–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ
- `automation.humidifier_track_level_minutes` ‚Äî –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É +1 –∫ —Å—á—ë—Ç—á–∏–∫—É —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
- `automation.humidifier_calibrate_rates` ‚Äî –ø—Ä–∏ –æ–ø—É—Å—Ç–æ—à–µ–Ω–∏–∏:
  - `correction = capacity / model_consumed`
  - –î–ª—è —É—Ä–æ–≤–Ω–µ–π —Å >5 –º–∏–Ω —Ä–∞–±–æ—Ç—ã ‚Äî EMA-–∫–æ—Ä—Ä–µ–∫—Ü–∏—è —Å—Ç–∞–≤–∫–∏
  - –£—Ä–æ–≤–Ω–∏ —Å <5 –º–∏–Ω ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö)
  - –°–±—Ä–æ—Å —Å—á—ë—Ç—á–∏–∫–∞ –º–∏–Ω—É—Ç

#### 2. –î–∞—à–±–æ—Ä–¥

- –î–æ–±–∞–≤–ª–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏ (`hours_remaining`)
- –î–æ–±–∞–≤–ª–µ–Ω—ã —Å—Ç—Ä–æ–∫–∏: –∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∞–≤–∫–∏, –º–∏–Ω—É—Ç—ã —Ç–µ–∫—É—â–µ–≥–æ —Ü–∏–∫–ª–∞, —Ü–∏–∫–ª—ã –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
- –£–±—Ä–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞ Resume Auto Control

#### 3. –°–µ–Ω—Å–æ—Ä—ã

- `sensor.humidifier_water_consumed` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ –≤–º–µ—Å—Ç–æ –ª–∏–Ω–µ–π–Ω–æ–π —Ñ–æ—Ä–º—É–ª—ã
- `sensor.humidifier_water_level` ‚Üí `hours_remaining` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç–∞–≤–∫—É —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
- –ê—Ç—Ä–∏–±—É—Ç `consumption_rates` –¥–æ–±–∞–≤–ª–µ–Ω –∫ water level sensor

---

## v9 ‚Äì ARCHITECTURE REWRITE / HYBRID 2.0 (2025-11-24)

**Commit:** TBD  
**Version:** 2.0.1

> –≠—Ç–∞ –≤–µ—Ä—Å–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –∫—Ä—É–ø–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–∏–∫–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–∫–µ—Ç–∞.  
> –í—Å–µ –∑–∞–ø–∏—Å–∏ v1‚Äìv8 –Ω–∏–∂–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ **–≤–µ—Ç–∫–µ 1.x** (—Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª —Å `input_boolean.humidity_auto_enabled` –∏ –¥—Ä—É–≥–æ–π –ª–æ–≥–∏–∫–æ–π HYBRID).

### –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

#### 1. –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ AUTO/MANUAL (–±–µ–∑ `input_boolean`)

- **–£–¥–∞–ª—ë–Ω** helper `input_boolean.humidity_auto_enabled`:
  - –†–µ–∂–∏–º AUTO —Ç–µ–ø–µ—Ä—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è **—Ñ–∞–∫—Ç–æ–º –≤–∫–ª—é—á—ë–Ω–Ω–æ—Å—Ç–∏**:
    - `automation.humidity_control_main` (–æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è).
- **MANUAL override**:
  - –õ—é–±–æ–µ –≤–Ω–µ—à–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —É–ø—Ä–∞–≤–ª—è—é—â–∏—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π (–ø—É–ª—å—Ç, –∫–Ω–æ–ø–∫–∏, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏), –Ω–µ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è–º–∏, –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:
    - –æ—Ç–∫–ª—é—á–µ–Ω–∏—é **—Ç–æ–ª—å–∫–æ** `automation.humidity_control_main`.
  - –í MANUAL –∞–≤—Ç–æ–º–∞—Ç –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç –Ω–∏ –ø–∏—Ç–∞–Ω–∏–µ, –Ω–∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å; —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Å—Ç–∞—ë—Ç—Å—è –≤ —Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –≤ –∫–æ—Ç–æ—Ä–æ–µ –ø–µ—Ä–µ–≤—ë–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å/–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è.
- **–í–æ–∑–≤—Ä–∞—Ç –≤ AUTO**:
  - –ß–µ—Ä–µ–∑ `script.humidity_auto_resume`, –∫–æ—Ç–æ—Ä—ã–π –≤–∫–ª—é—á–∞–µ—Ç:
    - `automation.humidity_control_main`,
    - `automation.humidity_manual_override_detector`.
  - –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ `humidity_control_main` —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `humidity_device_setup` (—Ç—Ä–∏–≥–≥–µ—Ä –ø–æ `automation.humidity_control_main ‚Üí 'on'`) –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.

#### 2. –î–µ—Ç–µ–∫—Ç–æ—Ä —Ä—É—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ä–∞—Å—à–∏—Ä–µ–Ω –∏ –∑–∞—â–∏—â—ë–Ω)

**Automation:** `humidity_manual_override_detector`

- **–¢—Ä–∏–≥–≥–µ—Ä—ã:** –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
  - `number.humidifier_puh_9105_puh_2709_intensity`
  - `switch.humidifier_puh_9105_puh_2709_power`
  - `humidifier.humidifier_puh_9105_puh_2709_humidifier` (attr `mode`)
  - `switch.humidifier_puh_9105_puh_2709_warm_stream`
  - `switch.humidifier_puh_9105_puh_2709_backlight`
  - `switch.humidifier_puh_9105_puh_2709_ioniser`
  - `switch.humidifier_puh_9105_puh_2709_sound`
- **–§–∏–ª—å—Ç—Ä—ã:**
  - `from_state != to_state`
  - `from_state.state` –Ω–µ –≤ `['unavailable', 'unknown', 'none']`
  - `state_attr('automation.humidity_control_main', 'current') == 0`
  - `state_attr('automation.humidity_device_setup', 'current') == 0`
- **–î–µ–π—Å—Ç–≤–∏—è:**
  - –û—Ç–∫–ª—é—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ `automation.humidity_control_main` ‚Üí –≤—Ö–æ–¥ –≤ MANUAL.

–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ `humidity_control_main` –∏ `humidity_device_setup` **–ø–µ—Ä–µ–¥ —Å–≤–æ–∏–º–∏ service‚Äë–≤—ã–∑–æ–≤–∞–º–∏** –≤—Ä–µ–º–µ–Ω–Ω–æ –≤—ã–∫–ª—é—á–∞—é—Ç `humidity_manual_override_detector`, —á—Ç–æ–±—ã –∏—Ö —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —Å—á–∏—Ç–∞–ª–∏—Å—å —Ä—É—á–Ω—ã–º–∏.

#### 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (device_setup 2.0)

**Automation:** `humidity_device_setup`

- **–¢—Ä–∏–≥–≥–µ—Ä:**
  - `state: automation.humidity_control_main ‚Üí 'on'`.
  - –¢–æ –µ—Å—Ç—å:
    - –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏–º–ø–æ—Ä—Ç–µ –ø–∞–∫–µ—Ç–∞ (–ø–æ—Å–ª–µ reload automations),
    - –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ HA (`initial_state: true` + –≤–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∏),
    - –ø—Ä–∏ —è–≤–Ω–æ–º –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ AUTO (—á–µ—Ä–µ–∑ `script.humidity_auto_resume`).
- **–î–µ–π—Å—Ç–≤–∏—è (–∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ, –Ω–æ —Å –∑–∞—â–∏—Ç–æ–π –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞):**
  - –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ—Ç `humidity_manual_override_detector`.
  - –í–∫–ª—é—á–∞–µ—Ç –ø–∏—Ç–∞–Ω–∏–µ `switch.‚Ä¶power`.
  - –°—Ç–∞–≤–∏—Ç —Ä–µ–∂–∏–º `home` –Ω–∞ `humidifier.‚Ä¶`.
  - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç:
    - –∑–≤—É–∫ OFF,
    - –ø–æ–¥—Å–≤–µ—Ç–∫—É OFF,
    - –±–ª–æ–∫–∏—Ä–æ–≤–∫—É ON,
    - –∏–æ–Ω–∏–∑–∞—Ç–æ—Ä ON,
    - –ø–æ–¥–æ–≥—Ä–µ–≤ ON.
  - –î–∞—ë—Ç –∑–∞–¥–µ—Ä–∂–∫—É (–æ–∫–æ–ª–æ 20 —Å–µ–∫—É–Ω–¥) –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ MQTT.
  - –í–∫–ª—é—á–∞–µ—Ç –¥–µ—Ç–µ–∫—Ç–æ—Ä –æ–±—Ä–∞—Ç–Ω–æ.

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, **device_setup –±–æ–ª—å—à–µ –Ω–µ –∑–∞–≤—è–∑–∞–Ω –Ω–∞ helper –∏–ª–∏ power‚Üíoff‚Äë—Ç—Ä–∏–≥–≥–µ—Ä—ã**, –∞ –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞—Ä—Ç—É–µ—Ç –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ AUTO.

#### 4. HYBRID‚Äë–∞–ª–≥–æ—Ä–∏—Ç–º –º–æ—â–Ω–æ—Å—Ç–∏ (–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è)

**Sensor:** `sensor.recommended_intensity`

- **Zoned control –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫:**

  ```text
  error > 10%          ‚Üí intensity = 7
  5%   < error ‚â§ 10%   ‚Üí intensity = 5
  2%   < error ‚â§ 5%    ‚Üí intensity = 3
  ```

- **Incremental control –≤–±–ª–∏–∑–∏ —Ü–µ–ª–∏ –∏ –ø—Ä–∏ –ø–µ—Ä–µ—É–≤–ª–∞–∂–Ω–µ–Ω–∏–∏:**

  ```text
  1%   < error ‚â§ 2%    ‚Üí intensity = current_intensity + 1   (–¥–æ max 7)
  error < ‚àí1%          ‚Üí intensity = current_intensity ‚àí 1   (–¥–æ min 0)
  ‚àí1% ‚â§ error ‚â§ 1%     ‚Üí intensity –Ω–µ –º–µ–Ω—è–µ–º (–≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å)
  ```

- **–ê–Ω—Ç–∏–¥—Ä–µ–±–µ–∑–≥ –ø–æ –≤—Ä–µ–º–µ–Ω–∏:**
  - –í `humidity_control_main` –¥–æ–±–∞–≤–ª–µ–Ω–æ —É—Å–ª–æ–≤–∏–µ:
    - –º–µ–Ω—è—Ç—å –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å –º–æ–º–µ–Ω—Ç–∞ `last_changed` —É `number.‚Ä¶intensity`
      –ø—Ä–æ—à–ª–æ > 300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç).

**–ò—Ç–æ–≥:**  
–∏—Å–∫–ª—é—á—ë–Ω runaway `current+1` –ø—Ä–∏ –º–∞–ª–æ–º –Ω–µ–¥–æ—É–≤–ª–∞–∂–Ω–µ–Ω–∏–∏,  
+ –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ —â–∞–¥—è—â–∏–π —Ä–µ–∂–∏–º (–Ω–µ –¥—ë—Ä–≥–∞–µ–º –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —á–∞—â–µ, —á–µ–º —Ä–∞–∑ –≤ 5 –º–∏–Ω—É—Ç, –∏ –Ω–µ –¥—ë—Ä–≥–∞–µ–º –≤ –∑–æ–Ω–µ ¬±1%).

#### 5. Template‚Äë—Å–µ–Ω—Å–æ—Ä—ã: –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ modern `template:` –≤ packages

- –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏ –ø–∞–∫–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª legacy `sensor: - platform: template`.
- –í v9:
  - template‚Äë—Å–µ–Ω—Å–æ—Ä—ã (`Adaptive Target Humidity`, `Humidity Error`, `Recommended Intensity`)
    –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ modern —Ñ–æ—Ä–º–∞—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ `template:`:
    ```yaml
    template:
      - sensor:
          - name: "Adaptive Target Humidity"
            unique_id: adaptive_target_humidity
            ...
    ```
  - –≠—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤–µ—Ä—Å–∏–π HA –∏ —É–ø—Ä–æ—â–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É.

#### 6. –£–ø—Ä–æ—â–µ–Ω–∏–µ reload/restart‚Äë–ª–æ–≥–∏–∫–∏

- –°—Ç–∞—Ä—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ `humidity_reload_recovery` + helper –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è.
- –í–∫–ª—é—á—ë–Ω–Ω–æ—Å—Ç—å AUTO –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è –∑–∞ —Å—á—ë—Ç:
  - `initial_state: true` —É `humidity_control_main` –∏ –¥—Ä—É–≥–∏—Ö –∫–ª—é—á–µ–≤—ã—Ö –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–π,
  - —è–≤–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ `script.humidity_auto_resume` –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏–º–ø–æ—Ä—Ç–µ –∏ –ø–æ –∂–µ–ª–∞–Ω–∏—é.

---

> ‚ö†Ô∏è **–ù–∏–∂–µ ‚Äì changelog –¥–ª—è –≤–µ—Ç–∫–∏ 1.x** (—Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª —Å helper‚Äô–æ–º –∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π HYBRID).  
> –û–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è —ç–≤–æ–ª—é—Ü–∏–∏ –ª–æ–≥–∏–∫–∏, –Ω–æ —á–∞—Å—Ç—å —ç—Ç–∏—Ö –¥–µ—Ç–∞–ª–µ–π –±–æ–ª—å—à–µ –Ω–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞ –≤ 2.0.

---

## v8 - FIX INCREMENTAL RUNAWAY (2025-11-22)

**Commit:** 41b2e7b  
**Version:** 1.1.2

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

**Incremental Logic Runaway Bug:**
- **–ü—Ä–æ–±–ª–µ–º–∞:** –î–∏–∞–ø–∞–∑–æ–Ω 0.5‚Äì2% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `current + 1` –Ω–∞ –ö–ê–ñ–î–û–ú —Ü–∏–∫–ª–µ (5 –º–∏–Ω).
- –ó–∞ 6 —Ü–∏–∫–ª–æ–≤ –¥–æ—Å—Ç–∏–≥–∞–ª max=7 –¥–∞–∂–µ –ø—Ä–∏ error=1.5%!
- Intensity –ù–ï —Å–Ω–∏–∂–∞–ª–∞—Å—å, –∫–æ–≥–¥–∞ error –ø–∞–¥–∞–ª —Å 2% –∫ 0.5%.
- **Root cause:** Incremental control –ø—Ä–∏–º–µ–Ω—è–ª—Å—è –í–ù–ï deadband (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è fine‚Äëtuning).

**–°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ (–±–∞–≥):**
```yaml
error > 2   ‚Üí 3 (zoned)
error > 0.5 ‚Üí current + 1 (incremental) ‚Üê RUNAWAY!
-0.5 to 0.5 ‚Üí maintain (deadband)
```

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (fix):**
```yaml
error > 2   ‚Üí 3 (zoned)
error > 1   ‚Üí 2 (zoned, NEW)
error > 0.5 ‚Üí 1 (zoned, NEW)
-0.5 to 0.5 ‚Üí maintain (deadband)
error < -0.5 ‚Üí 0 (turn off)
error < -2   ‚Üí current - 1 (incremental decrement)
```

**Rationale:**
- –î–∏–∞–ø–∞–∑–æ–Ω 0.5‚Äì2% ‚Äî —ç—Ç–æ –≤—Å—ë –µ—â—ë "—Å—Ä–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞", –Ω–µ –∑–æ–Ω–∞ —Ç–æ—á–Ω–æ–π –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∏.
- Incremental control –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è fine‚Äëtuning –≤ deadband –∏–ª–∏ –ø—Ä–∏ –ø–µ—Ä–µ—É–≤–ª–∞–∂–Ω–µ–Ω–∏–∏.
- Zoned‚Äë–ø–æ–¥—Ö–æ–¥ –¥–ª—è 0.5‚Äì2% –¥–∞—ë—Ç –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ.

### Production Testing (2025-11-22 12:49‚Äì12:58 UTC)

**Scenario 1: Small error (0.5‚Äì1%):**

- ‚úÖ BEFORE: error=1.65% ‚Üí recommended=7 (WRONG, runaway)
- ‚úÖ AFTER: error=0.5% ‚Üí recommended=1 (CORRECT)
- ‚úÖ Intensity –ù–ï —Ä–∞—Å—Ç—ë—Ç, –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ 1

**Scenario 2: Approach to target:**

- ‚úÖ Error: 0.5% ‚Üí 0.2% ‚Üí 0.1% ‚Üí 0.0%
- ‚úÖ Recommended: —Å—Ç–∞–±–∏–ª—å–Ω–æ 1 (–Ω–µ—Ç runaway)
- ‚úÖ Current: 39.84% ‚Üí 40.25% (–ø–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –∫ target ‚âà40.3%)

**Scenario 3: Overshoot (–ø–µ—Ä–µ—É–≤–ª–∞–∂–Ω–µ–Ω–∏–µ):**

- ‚úÖ Error: ‚àí0.1% ‚Üí ‚àí0.4% ‚Üí ‚àí0.5% ‚Üí ‚àí0.6%
- ‚úÖ Recommended: 1 ‚Üí 0 (–ø—Ä–∏ error < ‚àí0.5)
- ‚úÖ Power: ON ‚Üí OFF (12:55:48)
- ‚úÖ Power –æ—Å—Ç–∞—ë—Ç—Å—è OFF (v7‚Äëfix —Å–æ—Ö—Ä–∞–Ω—ë–Ω, –Ω–µ—Ç infinite loop)

### Files Changed (–≤–µ—Ç–∫–∞ 1.x):

- `packages/humidity/humidity_control.yaml` (—Å—Ç—Ä–æ–∫–∏ 4, 137‚Äì158)

---

## v7 - –§–ò–ù–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï (2025-11-22)

**Commit:** 33fd799

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

**1. Logic Deadlock –≤ control_main:**

- **–ü—Ä–æ–±–ª–µ–º–∞:** –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å—Ç–æ—è–ª–∞ **–ø–µ—Ä–µ–¥** —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –ø–∏—Ç–∞–Ω–∏–µ–º.
- –ï—Å–ª–∏ `power=off`, automation –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∞—Å—å ‚Üí —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏–µ–º –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–æ—Å—å.
- **Fix:** –±–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω **–ø–µ—Ä–µ–¥** –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏.
- –¢–µ–ø–µ—Ä—å automation —Å–Ω–∞—á–∞–ª–∞ —Ä–µ—à–∞–µ—Ç –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å power, –∑–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å.

**2. device_setup Infinite Loop:**

- **–ü—Ä–æ–±–ª–µ–º–∞:** `device_setup` —Ç—Ä–∏–≥–≥–µ—Ä–∏–ª—Å—è, –∫–æ–≥–¥–∞ `power ‚Üí off for 5 sec`, –∏ –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–ª power –æ–±—Ä–∞—Ç–Ω–æ, –¥–∞–∂–µ –ø—Ä–∏ `recommended=0`:
  - —Ü–∏–∫–ª: `control_main` –≤—ã–∫–ª—é—á–∞–µ—Ç ‚Üí `device_setup` –≤–∫–ª—é—á–∞–µ—Ç ‚Üí `control_main` –≤—ã–∫–ª—é—á–∞–µ—Ç‚Ä¶
- **Fix:** –¥–æ–±–∞–≤–ª–µ–Ω–∞ `condition` –ø–æ `recommended > 0` –≤ –Ω–∞—á–∞–ª–µ `action`.
- –¢–µ–ø–µ—Ä—å `device_setup` –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, –µ—Å–ª–∏ `recommended=0`, –∏ –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç power.

---

## v6 (corrected) - Fix elif order (2025-11-22)

**Commit:** 6959277

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

**recommended_intensity elif order bug:**

- **–ü—Ä–æ–±–ª–µ–º–∞:** `elif error < -0.5` —Å—Ç–æ—è–ª–æ **–ø–µ—Ä–µ–¥** `elif error < -2`.
- –í–µ—Ç–∫–∞ `error < -2` –±—ã–ª–∞ –Ω–µ–¥–æ—Å—Ç–∏–∂–∏–º–∞ (dead code).
- **Fix:** –ø–æ—Ä—è–¥–æ–∫ –∏–∑–º–µ–Ω—ë–Ω ‚Äî —Å–Ω–∞—á–∞–ª–∞ `error < -2`, –∑–∞—Ç–µ–º `error < -0.5`.

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞:**

```yaml
elif error > 0.5:     # ‚Üí increment
elif error < -2:      # ‚Üí decrement (check larger threshold first!)
elif error < -0.5:    # ‚Üí 0 (then smaller threshold)
else:                 # ‚Üí maintain
```

### –¢–µ—Å—Ç—ã:

- ‚úÖ –ü—Ä–∏ error = ‚àí1.9% recommended –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è 0.

---

## v6 - Power Management (2025-11-22)

**Commit:** e42bb9a

### –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:

**1. Power management –≤ control_main:**

- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è ¬´–£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–ò–¢–ê–ù–ò–ï–ú¬ª:
  - –ï—Å–ª–∏ `recommended=0` –∏ `power=on` ‚Üí –≤—ã–∫–ª—é—á–∏—Ç—å power.
  - –ï—Å–ª–∏ `recommended>0` –∏ `power=off` ‚Üí –≤–∫–ª—é—á–∏—Ç—å power.

**2. Conditional power –≤ device_setup:**

- `device_setup` –Ω–∞—á–∞–ª –ø—Ä–æ–≤–µ—Ä—è—Ç—å `recommended` –ø–µ—Ä–µ–¥ –≤–∫–ª—é—á–µ–Ω–∏–µ–º:
  - –ï—Å–ª–∏ `recommended>0` ‚Üí –≤–∫–ª—é—á–∏—Ç—å power,
  - –∏–Ω–∞—á–µ ‚Üí –≤—ã–∫–ª—é—á–∏—Ç—å power.

**3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ—Ä—è–¥–æ–∫ `elif` –≤ `recommended_intensity`:**

- –õ–æ–≥–∏–∫–∞:  
  `error < ‚àí2` ‚Üí decrement;  
  `‚àí2 < error < ‚àí0.5` ‚Üí 0;  
  `‚àí0.5 < error < 0.5` ‚Üí maintain.

---

## v5 - Detector Protection –¥–ª—è control_main (2025-11-22)

**Commit:** dc269bb

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

**control_main MQTT echo protection:**

- **–ü—Ä–æ–±–ª–µ–º–∞:** `control_main` –≤—ã–∑—ã–≤–∞—é—Ç —Å–µ—Ä–≤–∏—Å—ã ‚Üí MQTT –¥–∞—ë—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚Üí –¥–µ—Ç–µ–∫—Ç–æ—Ä —Å—á–∏—Ç–∞–µ—Ç —ç—Ç–æ —Ä—É—á–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º.
- **Fix:** `control_main` –≤—Ä–µ–º–µ–Ω–Ω–æ –≤—ã–∫–ª—é—á–∞–µ—Ç –¥–µ—Ç–µ–∫—Ç–æ—Ä:
  1. `automation.turn_off` detector;
  2. `number.set_value` (–∏–∑–º–µ–Ω–µ–Ω–∏–µ intensity);
  3. `delay: 20 sec` (–∂–¥—ë–º MQTT);
  4. `automation.turn_on` detector.

---

## v4 - –£–≤–µ–ª–∏—á–µ–Ω delay –¥–æ 20 sec (2025-11-22)

**Commit:** 90c7208

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

**device_setup delay increase:**

- **–ü—Ä–æ–±–ª–µ–º–∞:** MQTT‚Äëupdates –ø—Ä–∏—Ö–æ–¥–∏–ª–∏ –¥–æ 14+ —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.
- Delay 5 —Å–µ–∫—É–Ω–¥ –±—ã–ª –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω.
- **Fix:** —É–≤–µ–ª–∏—á–µ–Ω delay —Å 5 –¥–æ 20 —Å–µ–∫—É–Ω–¥.

---

## v3 - device_setup detector protection (2025-11-22)

**Commit:** eb2c61e

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

**device_setup MQTT echo protection:**

- **–ü—Ä–æ–±–ª–µ–º–∞:** `device_setup` –º–µ–Ω—è–µ—Ç intensity ‚Üí MQTT echoes ‚Üí detector —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—Å—è.
- **Fix:** `device_setup` –≤—Ä–µ–º–µ–Ω–Ω–æ –≤—ã–∫–ª—é—á–∞–µ—Ç –¥–µ—Ç–µ–∫—Ç–æ—Ä:
  1. `automation.turn_off` detector –≤ –Ω–∞—á–∞–ª–µ;
  2. –≤—Å–µ service calls;
  3. `delay: 5 sec`;
  4. `automation.turn_on` detector –≤ –∫–æ–Ω—Ü–µ.

---

## v2 - Detector logic fixes (2025-11-22)

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–≤–µ—Ç–∫–∞ —Å helper‚Äô–æ–º):

**manual_control_detector:**

- –£–±—Ä–∞–Ω trigger –Ω–∞ `power`.
- –î–æ–±–∞–≤–ª–µ–Ω `for: 2 —Å–µ–∫`.
- –ò–∑–º–µ–Ω–µ–Ω—ã conditions (–ø—Ä–æ–≤–µ—Ä–∫–∞ `current` –≤–º–µ—Å—Ç–æ `parent_id`).

**reload_recovery:**

- –£–±—Ä–∞–Ω–æ —É—Å–ª–æ–≤–∏–µ `helper="on"`.
- –î–æ–±–∞–≤–ª–µ–Ω–æ –≤–∫–ª—é—á–µ–Ω–∏–µ helper –≤ `action`.

---

## v1 - KVAZIS Pattern (2025-11-22)

### –ò–∑–º–µ–Ω–µ–Ω–∏—è:

**Automation naming:**

- –ü—Ä–∏–º–µ–Ω—ë–Ω kvazis pattern –¥–ª—è –≤—Å–µ—Ö 5 automations:
  - `id`: –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω–æ–µ –∏–º—è –¥–ª—è –ª—é–¥–µ–π (—Ä—É—Å—Å–∫–∏–π),
  - `alias`: —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∫–æ–¥ –¥–ª—è `entity_id` (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π, `[a-z0-9_]`).

**–ü—Ä–∏–º–µ—Ä—ã:**

```yaml
- id: "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–≤–ª–∞–∂–Ω–∏—Ç–µ–ª—è"
  alias: humidity_device_setup
  # ‚Üí automation.humidity_device_setup

- id: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å—é —É–≤–ª–∞–∂–Ω–∏—Ç–µ–ª—è"
  alias: humidity_control_main
  # ‚Üí automation.humidity_control_main
```

---

## Initial Implementation (2025-01-22)

–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `AUTOMATION_NAMING.md` –ø–æ—Å–ª–µ —á–µ—Ç–≤—ë—Ä—Ç–æ–≥–æ —Ä–∞–∑–∞ –∑–∞–±—ã–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è automations ü§¶

**–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ:**

- –ü—Ä–∞–≤–∏–ª–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ `entity_id` (slugify),
- –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è (`id`, `alias`, `description`),
- Best practices –ø–æ kvazis‚Äëpattern,
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `entity_id` —á–µ—Ä–µ–∑ REST API.