# ═══════════════════════════════════════════════════════════════════════════════
#  АВТОМАТИЗАЦИЯ УПРАВЛЕНИЯ УВЛАЖНИТЕЛЕМ POLARIS PUH-9105
#
#  Version: 1.1.2
#  Last Updated: 2025-11-22
# ═══════════════════════════════════════════════════════════════════════════════
#
#  🧪 НАУЧНО ОБОСНОВАННАЯ СИСТЕМА УПРАВЛЕНИЯ ВЛАЖНОСТЬЮ
#
#  Методология:
#    ✓ Hybrid Control: Zoned (kvazis) + Incremental (Stack Overflow)
#    ✓ Adaptive Humidity: двойная зависимость (комнатная + уличная температура)
#    ✓ 8 уровней интенсивности (0-7) с плавными переходами
#
#  Научная база:
#    • ВОЗ/WHO: 40-60% для здоровья и минимизации вирусов/бактерий
#    • ASHRAE Standard 55-2023: тепловой комфорт и точка росы ≤16.8°C
#    • ISO 7730 (ГОСТ Р ИСО 7730-2009): индекс PMV/PPD Фангера
#    • ГОСТ 30494-2011: 30-45% оптимум при 20-22°C
#
#  Формулы:
#    1. От комнатной T: base = 75 - (1.25 × T_room) [ISO 7730]
#    2. От уличной T: limit = 50 - max(0, 10 - T_outdoor) [ASHRAE]
#    3. Финальная: target = min(base, limit, 60) [ВОЗ максимум]
#
# ═══════════════════════════════════════════════════════════════════════════════

# ──────────────────────────────────────────────────────────────────────────────
#  INPUT HELPERS
# ──────────────────────────────────────────────────────────────────────────────

input_boolean:
  # Включение/выключение автоматизации
  humidity_auto_enabled:
    name: "Автоматизация влажности"
    initial: true
    icon: mdi:robot

# ──────────────────────────────────────────────────────────────────────────────
#  TEMPLATE SENSORS
# ──────────────────────────────────────────────────────────────────────────────

template:
  - sensor:
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      #  АДАПТИВНАЯ ЦЕЛЕВАЯ ВЛАЖНОСТЬ (двойная зависимость)
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - name: "Adaptive Target Humidity"
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:water-thermometer-outline
        state: >
            {# Температура в комнате (от датчика sensor-zap) #}
            {% set T_room = states('sensor.sensor_zap_temperature') | float(22) %}

            {# Температура на улице (Met.no weather integration) #}
            {% set T_outdoor = state_attr('weather.forecast_home_assistant', 'temperature') | float(0) %}

            {# ═══════════════════════════════════════════════════════════════ #}
            {# ФОРМУЛА 1: Базовая цель от КОМНАТНОЙ температуры              #}
            {# Источник: ISO 7730 (тепловой комфорт Фангера)                 #}
            {# Логика: при T↑ → RH↓ (высокая влажность + жара = духота)     #}
            {# ═══════════════════════════════════════════════════════════════ #}
            {% set base_indoor = 75 - (1.25 * T_room) %}

            {# Примеры:                                                        #}
            {# T_room=18°C → 75-22.5 = 52.5%                                  #}
            {# T_room=20°C → 75-25.0 = 50.0%                                  #}
            {# T_room=22°C → 75-27.5 = 47.5%                                  #}
            {# T_room=24°C → 75-30.0 = 45.0%                                  #}
            {# T_room=26°C → 75-32.5 = 42.5%                                  #}

            {# ═══════════════════════════════════════════════════════════════ #}
            {# ФОРМУЛА 2: Ограничение от УЛИЧНОЙ температуры                 #}
            {# Источник: ASHRAE/Aprilaire guidelines                          #}
            {# Логика: холодный воздух при нагреве теряет RH → нужно меньше  #}
            {#         увлажнение, иначе конденсат на холодных поверхностях  #}
            {# ═══════════════════════════════════════════════════════════════ #}
            {% set outdoor_limit = 50 - [0, 10 - T_outdoor] | max %}

            {# Примеры (ASHRAE рекомендации):                                 #}
            {# T_outdoor > +10°C  → 50 - 0   = 50%                            #}
            {# T_outdoor = +5°C   → 50 - 5   = 45%                            #}
            {# T_outdoor = 0°C    → 50 - 10  = 40%                            #}
            {# T_outdoor = -10°C  → 50 - 20  = 30%                            #}
            {# T_outdoor = -20°C  → 50 - 30  = 20%                            #}
            {# T_outdoor = -30°C  → 50 - 40  = 10% (но мин. 15% от ВОЗ)      #}

            {# ═══════════════════════════════════════════════════════════════ #}
            {# ФИНАЛЬНЫЙ РАСЧЕТ: берём минимум из всех ограничений            #}
            {# + медицинские границы от ВОЗ: 40-60%                           #}
            {# ═══════════════════════════════════════════════════════════════ #}
            {% set target = [base_indoor, outdoor_limit, 60] | min | float %}
            {% set target = [target, 40] | max %}  {# Минимум 40% (ВОЗ) #}

            {{ target | round(1) }}

      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      #  ТЕКУЩЕЕ ОТКЛОНЕНИЕ (ошибка регулирования)
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - name: "Humidity Error"
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:delta
        state: >
            {% set target = states('sensor.adaptive_target_humidity') | float(45) %}
            {% set current = states('sensor.sensor_zap_humidity') | float(50) %}
            {{ (target - current) | round(1) }}

      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      #  РЕКОМЕНДУЕМАЯ ИНТЕНСИВНОСТЬ (HYBRID метод)
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - name: "Recommended Intensity"
        icon: mdi:gauge
        state: >
            {% set error = states('sensor.humidity_error') | float(0) %}
            {% set current_intensity = states('number.humidifier_puh_9105_puh_2709_intensity') | int(0) %}

            {# ═══════════════════════════════════════════════════════════════ #}
            {# HYBRID CONTROL LOGIC                                            #}
            {# ═══════════════════════════════════════════════════════════════ #}

            {# ─────────────────────────────────────────────────────────────── #}
            {# РЕЖИМ 1: ZONED CONTROL (для больших отклонений)                #}
            {# Источник: kvazis living_humidity.yaml                           #}
            {# Логика: быстрая реакция на значительные отклонения             #}
            {# ─────────────────────────────────────────────────────────────── #}
            {% if error > 10 %}
              {# Критически низкая влажность → максимальная мощность #}
              7
            {% elif error > 5 %}
              {# Низкая влажность → высокая мощность #}
              5
            {% elif error > 2 %}
              {# Умеренно низкая → средняя мощность #}
              3
            {% elif error > 1 %}
              {# Малое отклонение 1-2% → низкая-средняя мощность #}
              2
            {% elif error > 0.5 %}
              {# Очень малое отклонение 0.5-1% → минимальная мощность #}
              1

            {# ─────────────────────────────────────────────────────────────── #}
            {# РЕЖИМ 2: INCREMENTAL CONTROL (переувлажнение)                  #}
            {# Источник: Stack Overflow incremental method                     #}
            {# Логика: плавное снижение при переувлажнении                    #}
            {# ─────────────────────────────────────────────────────────────── #}
            {% elif error < -2 %}
              {# Сильное превышение → снизить на 1 (мин 0) #}
              {{ [current_intensity - 1, 0] | max }}
            {% elif error < -0.5 %}
              {# Превышение цели → ВЫКЛЮЧИТЬ (0) #}
              0
            {% else %}
              {# В пределах целевого диапазона (-0.5 до +0.5) → не менять #}
              {{ current_intensity }}
            {% endif %}

# ──────────────────────────────────────────────────────────────────────────────
#  AUTOMATIONS
# ──────────────────────────────────────────────────────────────────────────────

automation:
  # ══════════════════════════════════════════════════════════════════════════
  #  ИНИЦИАЛИЗАЦИЯ УСТРОЙСТВА
  # ══════════════════════════════════════════════════════════════════════════
  - id: "Инициализация увлажнителя"
    alias: humidity_device_setup
    description: "Включение и настройка всех параметров устройства"
    mode: single
    max_exceeded: silent

    trigger:
      # При включении автоматизации
      - platform: state
        entity_id: input_boolean.humidity_auto_enabled
        to: "on"
      # При выключении питания устройства
      - platform: state
        entity_id: switch.humidifier_puh_9105_puh_2709_power
        to: "off"
        for:
          seconds: 5

    condition:
      - condition: state
        entity_id: input_boolean.humidity_auto_enabled
        state: "on"

    action:
      - variables:
          recommended: "{{ states('sensor.recommended_intensity') | int(0) }}"

      # ВАЖНО: Если recommended=0, НЕ запускать device_setup!
      # Иначе создаётся цикл: control_main выключает power → device_setup включает обратно
      - condition: template
        value_template: "{{ recommended > 0 }}"

      # Шаг 0: Выключить manual_control_detector чтобы не сработал во время setup
      - service: automation.turn_off
        target:
          entity_id: automation.humidity_manual_control_detector

      # Шаг 1: Включить питание
      - service: switch.turn_on
        target:
          entity_id: switch.humidifier_puh_9105_puh_2709_power

      # Шаг 2: Подождать загрузки устройства
      - delay:
          seconds: 2

      # Шаг 3: Установить режим "home" (manual control)
      - service: humidifier.set_mode
        target:
          entity_id: humidifier.humidifier_puh_9105_puh_2709_humidifier
        data:
          mode: "home"

      # Шаг 4: Настроить switches
      # Отключить звук (пищалку)
      - service: switch.turn_off
        target:
          entity_id: switch.humidifier_puh_9105_puh_2709_sound

      # Включить блокировку
      - service: switch.turn_on
        target:
          entity_id: switch.humidifier_puh_9105_puh_2709_child_lock

      # Включить ионизацию
      - service: switch.turn_on
        target:
          entity_id: switch.humidifier_puh_9105_puh_2709_ioniser

      # Включить подогрев (теплый пар)
      - service: switch.turn_on
        target:
          entity_id: switch.humidifier_puh_9105_puh_2709_warm_stream

      # Выключить подсветку
      - service: switch.turn_off
        target:
          entity_id: switch.humidifier_puh_9105_puh_2709_backlight

      # Шаг 5: Подождать чтобы все MQTT updates пришли и устройство стабилизировалось
      - delay:
          seconds: 20

      # Шаг 6: Включить manual_control_detector обратно
      - service: automation.turn_on
        target:
          entity_id: automation.humidity_manual_control_detector

  # ══════════════════════════════════════════════════════════════════════════
  #  ОСНОВНАЯ АВТОМАТИЗАЦИЯ УПРАВЛЕНИЯ
  # ══════════════════════════════════════════════════════════════════════════
  - id: "Управление интенсивностью увлажнителя"
    alias: humidity_control_main
    description: "Hybrid adaptive control: комнатная + уличная температура"
    mode: single
    max_exceeded: silent

    trigger:
      # Периодическая проверка каждые 5 минут
      - platform: time_pattern
        minutes: "/5"
      # При изменении текущей влажности
      - platform: state
        entity_id: sensor.sensor_zap_humidity
      # При изменении комнатной температуры
      - platform: state
        entity_id: sensor.sensor_zap_temperature
      # При изменении уличной температуры
      - platform: state
        entity_id: weather.forecast_home_assistant
        attribute: temperature

    condition:
      # Автоматизация должна быть включена
      - condition: state
        entity_id: input_boolean.humidity_auto_enabled
        state: "on"
      # Устройство без критических ошибок
      - condition: template
        value_template: >
          {% set err = states('sensor.humidifier_puh_9105_puh_2709_error') %}
          {{ err in ['00', 'no_error', '02', 'child_lock', '', 'unknown', 'unavailable'] }}

    action:
      - variables:
          recommended: "{{ states('sensor.recommended_intensity') | int(0) }}"
          current: "{{ states('number.humidifier_puh_9105_puh_2709_intensity') | int(0) }}"

      # ────────────────────────────────────────────────────────────────────────
      # УПРАВЛЕНИЕ ПИТАНИЕМ (в зависимости от recommended)
      # ────────────────────────────────────────────────────────────────────────
      # ВАЖНО: Эта секция ДОЛЖНА быть ПЕРЕД проверкой готовности!
      # Иначе если power=off, automation остановится и не сможет включить power.
      - choose:
          # Если recommended = 0 → ВЫКЛЮЧИТЬ питание
          - conditions:
              - condition: template
                value_template: "{{ recommended == 0 }}"
              - condition: state
                entity_id: switch.humidifier_puh_9105_puh_2709_power
                state: "on"
            sequence:
              - service: switch.turn_off
                target:
                  entity_id: switch.humidifier_puh_9105_puh_2709_power
          # Если recommended > 0 И power OFF → ВКЛЮЧИТЬ питание
          - conditions:
              - condition: template
                value_template: "{{ recommended > 0 }}"
              - condition: state
                entity_id: switch.humidifier_puh_9105_puh_2709_power
                state: "off"
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.humidifier_puh_9105_puh_2709_power
              - delay:
                  seconds: 2  # Ждём загрузки устройства

      # ────────────────────────────────────────────────────────────────────────
      # ПРОВЕРКА ГОТОВНОСТИ УСТРОЙСТВА
      # ────────────────────────────────────────────────────────────────────────
      # Если устройство НЕ готово → остановиться
      # NOTE: После управления питанием - если power всё ещё off, значит recommended=0
      - choose:
          # Если power OFF или режим неправильный → остановиться
          - conditions:
              - condition: or
                conditions:
                  - condition: state
                    entity_id: switch.humidifier_puh_9105_puh_2709_power
                    state: "off"
                  - condition: template
                    value_template: >
                      {{ state_attr('humidifier.humidifier_puh_9105_puh_2709_humidifier', 'mode') != 'home' }}
            sequence:
              - stop: "Устройство выключено (recommended=0) или режим неправильный"

          # Если бак снят/пуст → только остановиться (уведомление отправит water_empty)
          - conditions:
              - condition: state
                entity_id: binary_sensor.humidifier_puh_9105_puh_2709_water_tank
                state: "on"
            sequence:
              - stop: "Нет воды в баке"

      # ────────────────────────────────────────────────────────────────────────
      # УПРАВЛЕНИЕ ИНТЕНСИВНОСТЬЮ (если устройство готово)
      # ────────────────────────────────────────────────────────────────────────
      # Устанавливаем только если изменилась
      - condition: template
        value_template: "{{ recommended != current }}"

      # Выключить detector перед изменением intensity
      - service: automation.turn_off
        target:
          entity_id: automation.humidity_manual_control_detector

      - service: number.set_value
        target:
          entity_id: number.humidifier_puh_9105_puh_2709_intensity
        data:
          value: "{{ recommended }}"

      # Подождать MQTT updates
      - delay:
          seconds: 20

      # Включить detector обратно
      - service: automation.turn_on
        target:
          entity_id: automation.humidity_manual_control_detector

  # ══════════════════════════════════════════════════════════════════════════
  #  ДЕТЕКТОР РУЧНОГО УПРАВЛЕНИЯ
  # ══════════════════════════════════════════════════════════════════════════
  - id: "Детектор ручного управления увлажнителем"
    alias: humidity_manual_control_detector
    description: "Останавливает автоматизацию при изменении НЕ от неё"
    mode: restart

    trigger:
      # Ручное изменение интенсивности
      - platform: state
        entity_id: number.humidifier_puh_9105_puh_2709_intensity
        for:
          seconds: 2

    condition:
      # Value ДОЛЖЕН измениться (не только state update, но и value change)
      - condition: template
        value_template: >
          {{ trigger.from_state.state != trigger.to_state.state }}
      # Игнорировать инициализацию entity (unavailable/unknown → число)
      - condition: template
        value_template: >
          {{ trigger.from_state.state not in ['unavailable', 'unknown', 'none'] }}
      # НЕ срабатывать если device_setup или control_main работают СЕЙЧАС
      - condition: template
        value_template: >
          {{ state_attr('automation.humidity_device_setup', 'current') | int(0) == 0 and
             state_attr('automation.humidity_control_main', 'current') | int(0) == 0 }}

    action:
      # Выключить автоматизацию
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.humidity_auto_enabled

  # ══════════════════════════════════════════════════════════════════════════
  #  УВЕДОМЛЕНИЕ: ОШИБКА УСТРОЙСТВА
  # ══════════════════════════════════════════════════════════════════════════
  - id: "Ошибка увлажнителя"
    alias: humidity_device_error
    description: "Уведомление при возникновении ошибки устройства"
    mode: single

    trigger:
      # При изменении error sensor
      - platform: state
        entity_id: sensor.humidifier_puh_9105_puh_2709_error

    condition:
      # Только если есть критическая ошибка (не 00, не 02)
      - condition: template
        value_template: >
          {% set err = trigger.to_state.state %}
          {{ err not in ['00', 'no_error', '02', 'child_lock', '', 'unknown', 'unavailable'] }}

    action:
      - variables:
          error_code: "{{ states('sensor.humidifier_puh_9105_puh_2709_error') }}"
          error_title: >
            {% if error_code == '01' or error_code == 'low_water' %}
              💧 Мало воды в увлажнителе
            {% elif error_code == '03' or error_code == 'replace_filter' %}
              🔧 Замените фильтр увлажнителя
            {% elif error_code == '04' or error_code == 'maximum_schedules' %}
              ⚠️ Превышено количество расписаний
            {% elif error_code == '05' or error_code == 'clean_tank' %}
              🧼 Очистите бак увлажнителя
            {% else %}
              ⚠️ Ошибка увлажнителя
            {% endif %}
          error_message: >
            {% if error_code == '01' or error_code == 'low_water' %}
              Уровень воды слишком низкий.
              Наполните бак чистой водой.
            {% elif error_code == '03' or error_code == 'replace_filter' %}
              Фильтр загрязнён и требует замены.
              Установите новый фильтр для продолжения работы.

              Управление приостановлено до замены фильтра.
            {% elif error_code == '04' or error_code == 'maximum_schedules' %}
              Достигнуто максимальное количество настроенных расписаний.
              Удалите неиспользуемые расписания через приложение.
            {% elif error_code == '05' or error_code == 'clean_tank' %}
              Бак требует очистки от накипи и бактерий.
              Выполните очистку согласно инструкции.

              Управление приостановлено до очистки бака.
            {% else %}
              Код ошибки: {{ error_code }}
              Проверьте устройство и обратитесь к инструкции.
            {% endif %}

      - service: notify.zapgroup
        data:
          title: "{{ error_title }}"
          message: >
            {{ error_message }}

            Текущая влажность: {{ states('sensor.sensor_zap_humidity') }}%
            Целевая влажность: {{ states('sensor.adaptive_target_humidity') }}%

  # ══════════════════════════════════════════════════════════════════════════
  #  ВОССТАНОВЛЕНИЕ ПОСЛЕ RELOAD/RESTART
  # ══════════════════════════════════════════════════════════════════════════
  - id: "Восстановление после reload/restart"
    alias: humidity_reload_recovery
    description: "Инициализация устройства при reload/restart если автоматизация включена"
    mode: single

    trigger:
      # При reload automations
      - platform: event
        event_type: automation_reloaded
      # При HA restart
      - platform: homeassistant
        event: start

    condition:
      # Устройство не готово
      - condition: or
        conditions:
          - condition: state
            entity_id: switch.humidifier_puh_9105_puh_2709_power
            state: "off"
          - condition: template
            value_template: >
              {{ state_attr('humidifier.humidifier_puh_9105_puh_2709_humidifier', 'mode') != 'home' }}

    action:
      # Задержка чтобы все entities загрузились
      - delay:
          seconds: 5
      # Включить helper
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.humidity_auto_enabled
      # Подождать чтобы helper точно включился
      - delay:
          seconds: 1
      # Запустить device setup
      - service: automation.trigger
        target:
          entity_id: automation.humidity_device_setup

# ═══════════════════════════════════════════════════════════════════════════════
#  📋 ИНСТРУКЦИИ ПО ИСПОЛЬЗОВАНИЮ
# ═══════════════════════════════════════════════════════════════════════════════
#
#  1. ПЕРЕЗАГРУЗКА КОНФИГУРАЦИИ:
#     Developer Tools → YAML → "YAML configuration reloading"
#     → Reload all YAML configuration
#
#  2. ПРОВЕРКА РАБОТЫ:
#     Developer Tools → States → найти:
#     • sensor.adaptive_target_humidity - целевая влажность (адаптивная)
#     • sensor.humidity_error - текущее отклонение
#     • sensor.recommended_intensity - рекомендуемая мощность
#
#  3. УПРАВЛЕНИЕ:
#     Settings → Devices & Services → Helpers:
#     • input_boolean.humidity_auto_enabled - вкл/выкл автоматизацию
#       (автоматически выключается при ручном управлении увлажнителем)
#
#  4. МОНИТОРИНГ:
#     • sensor.sensor_zap_humidity - текущая влажность в комнате
#     • sensor.sensor_zap_temperature - температура в комнате
#     • weather.forecast_home_assistant - уличная температура (Met.no)
#     • number.humidifier_puh_9105_puh_2709_intensity - интенсивность (0-7)
#
#  5. ПОНИМАНИЕ АДАПТИВНОГО АЛГОРИТМА:
#     Формула учитывает ДВА фактора:
#
#     A) Комнатная температура (тепловой комфорт ISO 7730):
#        - 18°C → цель 52.5%
#        - 20°C → цель 50.0%
#        - 22°C → цель 47.5%
#        - 24°C → цель 45.0%
#        - 26°C → цель 42.5%
#
#     B) Уличная температура (ASHRAE рекомендации):
#        - > +10°C → макс 50%
#        - 0°C → макс 40%
#        - -10°C → макс 30%
#        - -20°C → макс 20%
#
#     Финальная цель = min(A, B) в диапазоне 40-60% (ВОЗ)
#
#  6. МЕТОД УПРАВЛЕНИЯ (HYBRID):
#     • При error > 10% → интенсивность 7 (максимум)
#     • При error > 5% → интенсивность 5
#     • При error > 2% → интенсивность 3
#     • При error > 0.5% → текущая + 1 (постепенно)
#     • При error < -2% → текущая - 1 (постепенно)
#     • При |error| < 0.5% → не менять (гистерезис)
#
# ═══════════════════════════════════════════════════════════════════════════════
