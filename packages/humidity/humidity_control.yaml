# package: puh_9105_humidity
# Version: 2.0.5
# Last Updated: 2025-11-25
# Fix: Added homeassistant start trigger to device_setup for automatic mode restoration after restart

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#  TEMPLATE SENSORS
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


template:
  - trigger:
      # –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –≤—Å–µ—Ö source entities
      - platform: state
        entity_id: sensor.sensor_eva_humidity
      - platform: state
        entity_id: sensor.sensor_eva_temperature
      - platform: state
        entity_id: weather.forecast_home_assistant
        attribute: temperature
      # Fallback: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
      - platform: time_pattern
        minutes: "/5"
    sensor:
      # –ê–î–ê–ü–¢–ò–í–ù–ê–Ø –¶–ï–õ–ï–í–ê–Ø –í–õ–ê–ñ–ù–û–°–¢–¨ (–í–û–ó + —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã)
      - name: "Adaptive Target Humidity"
        unique_id: adaptive_target_humidity
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:water-thermometer-outline
        availability: >
          {{ has_value('sensor.sensor_eva_temperature') and
             has_value('weather.forecast_home_assistant') }}
        state: >
          {# –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ –∫–æ–º–Ω–∞—Ç–µ #}
          {% set T_room = states('sensor.sensor_eva_temperature') | float(22) %}
          {# –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–∞ —É–ª–∏—Ü–µ (Met.no / –¥—Ä—É–≥–∞—è weather-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è) #}
          {% set T_outdoor = state_attr('weather.forecast_home_assistant', 'temperature') | float(0) %}

          {# –ë–∞–∑–æ–≤–∞—è —Ü–µ–ª—å –æ—Ç –∫–æ–º–Ω–∞—Ç–Ω–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã (–∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω) #}
          {% set base_indoor = 75 - (1.25 * T_room) %}
          {# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—Ç —É–ª–∏—á–Ω–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã (ASHRAE/REHVA/Aprilaire-–ø–æ–¥—Ö–æ–¥) #}
          {% set outdoor_limit = 50 - [0, 10 - T_outdoor] | max %}

          {# –ò—Ç–æ–≥: –º–∏–Ω–∏–º—É–º –∏–∑ indoor/outdoor/–º–∞–∫—Å–∏–º—É–º–∞ 60% #}
          {% set target = [base_indoor, outdoor_limit, 60] | min | float %}
          {# –ñ—ë—Å—Ç–∫–∏–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –í–û–ó: 40‚Äì60% #}
          {% set target = [target, 40] | max %}

          {{ target | round(1) }}

      # –¢–ï–ö–£–©–ï–ï –û–¢–ö–õ–û–ù–ï–ù–ò–ï (–æ—à–∏–±–∫–∞ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
      - name: "Humidity Error"
        unique_id: humidity_error
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:delta
        availability: >
          {{ has_value('sensor.adaptive_target_humidity') and
             has_value('sensor.sensor_eva_humidity') }}
        state: >
          {% set target = states('sensor.adaptive_target_humidity') | float(45) %}
          {% set current = states('sensor.sensor_eva_humidity') | float(50) %}
          {{ (target - current) | round(1) }}

      # –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–ê–Ø –ò–ù–¢–ï–ù–°–ò–í–ù–û–°–¢–¨ (HYBRID + –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å ¬±1%)
      - name: "Recommended Intensity"
        unique_id: humidity_recommended_intensity
        icon: mdi:gauge
        availability: >
          {{ has_value('sensor.humidity_error') and
             has_value('number.humidifier_puh_9105_puh_2709_intensity') }}
        state: >
          {% set error = states('sensor.humidity_error') | float(0) %}
          {% set current_intensity = states('number.humidifier_puh_9105_puh_2709_intensity') | int(0) %}

          {# –ö—Ä—É–ø–Ω—ã–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏: –±—ã—Å—Ç—Ä—ã–π –≤—ã—Ö–æ–¥ –Ω–∞ –≤–µ—Ä—Ö–Ω–∏–µ –∑–æ–Ω—ã #}
          {% if error > 10 %}
            7
          {% elif error > 5 %}
            5
          {% elif error > 2 %}
            3

          {# –ú–∞–ª–æ–µ –Ω–µ–¥–æ—É–≤–ª–∞–∂–Ω–µ–Ω–∏–µ: –≥–∏–±—Ä–∏–¥–Ω–∞—è —á–∞—Å—Ç—å, –ø–ª–∞–≤–Ω—ã–π —Ä–æ—Å—Ç #}
          {% elif error > 1 %}
            {{ [current_intensity + 1, 7] | min }}

          {# –ü–µ—Ä–µ—É–≤–ª–∞–∂–Ω–µ–Ω–∏–µ: –ø–ª–∞–≤–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 1 —Å—Ç—É–ø–µ–Ω—å #}
          {% elif error < -1 %}
            {{ [current_intensity - 1, 0] | max }}

          {# –ó–æ–Ω–∞ –ø–æ–∫–æ—è ¬±1%: –Ω–µ –º–µ–Ω—è–µ–º –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—Ä–µ–±–µ–∑–≥–∞) #}
          {% else %}
            {{ current_intensity }}
          {% endif %}

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#  SCRIPTS
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

script:
  humidity_auto_resume:
    alias: "–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ‚Äë—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–ª–∞–∂–Ω–∏—Ç–µ–ª–µ–º"
    mode: single
    sequence:
      # –í–∫–ª—é—á–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É –∏ –¥–µ—Ç–µ–∫—Ç–æ—Ä —Ä—É—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      - service: automation.turn_on
        target:
          entity_id:
            - automation.humidity_control_main
            - automation.humidity_manual_override_detector
      # –î–∞–ª–µ–µ device_setup —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∞–º –ø–æ —Ç—Ä–∏–≥–≥–µ—Ä—É "control_main ‚Üí on"

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#  AUTOMATIONS
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

automation:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  #  –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –£–°–¢–†–û–ô–°–¢–í–ê
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  - id: humidity_device_setup
    alias: humidity_device_setup
    mode: single
    max_exceeded: silent
    initial_state: true

    trigger:
      # –í—Ö–æ–¥–∏–º –≤ AUTO: –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è humidity_control_main –≤–∫–ª—é—á–µ–Ω–∞
      - platform: state
        entity_id: automation.humidity_control_main
        to: "on"
      # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ restart Home Assistant
      - platform: homeassistant
        event: start


    condition:
      # –°—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ control_main –≤–∫–ª—é—á–µ–Ω–∞ (AUTO —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω)
      - condition: state
        entity_id: automation.humidity_control_main
        state: "on"

    action:
      # –û—Ç–∫–ª—é—á–∞–µ–º –¥–µ—Ç–µ–∫—Ç–æ—Ä, —á—Ç–æ–±—ã –Ω–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ —Å—á–∏—Ç–∞–ª–∏—Å—å —Ä—É—á–Ω—ã–º–∏
      - service: automation.turn_off
        target:
          entity_id: automation.humidity_manual_override_detector

      # –í–∫–ª—é—á–∏—Ç—å –ø–∏—Ç–∞–Ω–∏–µ
      - service: switch.turn_on
        target:
          entity_id: switch.humidifier_puh_9105_puh_2709_power

      # –ü–æ–¥–æ–∂–¥–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
      - delay:
          seconds: 2

      # –†–µ–∂–∏–º "home" (—Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–Ω–∞—Ä—É–∂–∏, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑ HA)
      - service: humidifier.set_mode
        target:
          entity_id: humidifier.humidifier_puh_9105_puh_2709_humidifier
        data:
          mode: "home"

      # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–ª–µ–≤—É—é –≤–ª–∞–∂–Ω–æ—Å—Ç—å –Ω–∞ –º–∞–∫—Å–∏–º—É–º (—Ä–µ–∂–∏–º Intensity —Å–ª–µ–¥—É–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É humidity!)
      - service: humidifier.set_humidity
        target:
          entity_id: humidifier.humidifier_puh_9105_puh_2709_humidifier
        data:
          humidity: 75

      # –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏
      - service: switch.turn_off
        target:
          entity_id:
            - switch.humidifier_puh_9105_puh_2709_sound
            - switch.humidifier_puh_9105_puh_2709_backlight
      - service: switch.turn_on
        target:
          entity_id:
            - switch.humidifier_puh_9105_puh_2709_child_lock
            - switch.humidifier_puh_9105_puh_2709_ioniser
            - switch.humidifier_puh_9105_puh_2709_warm_stream

      # –ü–æ–¥–æ–∂–¥–∞—Ç—å, —á—Ç–æ–±—ã MQTT‚Äë—Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏—Å—å
      - delay:
          seconds: 20

      # –í–∫–ª—é—á–∏—Ç—å –¥–µ—Ç–µ–∫—Ç–æ—Ä –æ–±—Ä–∞—Ç–Ω–æ
      - service: automation.turn_on
        target:
          entity_id: automation.humidity_manual_override_detector

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  #  –û–°–ù–û–í–ù–ê–Ø –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø (AUTO)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  - id: humidity_control_main
    alias: humidity_control_main
    mode: single
    max_exceeded: silent
    initial_state: true

    trigger:
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
      - platform: time_pattern
        minutes: "/5"
      # –†–µ–∞–∫—Ü–∏—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
      - platform: state
        entity_id: sensor.sensor_eva_humidity
      # –†–µ–∞–∫—Ü–∏—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–º–Ω–∞—Ç–Ω–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
      - platform: state
        entity_id: sensor.sensor_eva_temperature
      # –†–µ–∞–∫—Ü–∏—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É–ª–∏—á–Ω–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
      - platform: state
        entity_id: weather.forecast_home_assistant
        attribute: temperature

    condition:
      # –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –±–µ–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
      - condition: template
        value_template: >
          {% set err = states('sensor.humidifier_puh_9105_puh_2709_error') %}
          {{ err in ['00', 'no_error', '02', 'child_lock', '', 'unknown', 'unavailable'] }}

    action:
      - variables:
          recommended: "{{ states('sensor.recommended_intensity') | int(0) }}"
          current: "{{ states('number.humidifier_puh_9105_puh_2709_intensity') | int(0) }}"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–ò–¢–ê–ù–ò–ï–ú
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - choose:
          # recommended = 0 ‚Üí –≤—ã–∫–ª—é—á–∏—Ç—å –ø–∏—Ç–∞–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –≤–∫–ª—é—á–µ–Ω–æ
          - conditions:
              - condition: template
                value_template: "{{ recommended == 0 }}"
              - condition: template
                value_template: "{{ states('switch.humidifier_puh_9105_puh_2709_power') == 'on' }}"
            sequence:
              - service: automation.turn_off
                target:
                  entity_id: automation.humidity_manual_override_detector
              - service: switch.turn_off
                target:
                  entity_id: switch.humidifier_puh_9105_puh_2709_power
              - delay:
                  seconds: 2
              - service: automation.turn_on
                target:
                  entity_id: automation.humidity_manual_override_detector

          # recommended > 0 –∏ –ø–∏—Ç–∞–Ω–∏–µ –Ω–µ ON ‚Üí –≤–∫–ª—é—á–∏—Ç—å –ø–∏—Ç–∞–Ω–∏–µ
          - conditions:
              - condition: template
                value_template: "{{ recommended > 0 }}"
              - condition: template
                value_template: "{{ states('switch.humidifier_puh_9105_puh_2709_power') != 'on' }}"
            sequence:
              - service: automation.turn_off
                target:
                  entity_id: automation.humidity_manual_override_detector
              - service: switch.turn_on
                target:
                  entity_id: switch.humidifier_puh_9105_puh_2709_power
              - delay:
                  seconds: 2
              - service: automation.turn_on
                target:
                  entity_id: automation.humidity_manual_override_detector

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # –ü–†–û–í–ï–†–ö–ê –ì–û–¢–û–í–ù–û–°–¢–ò –£–°–¢–†–û–ô–°–¢–í–ê
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - choose:
          # –ï—Å–ª–∏ –ø–∏—Ç–∞–Ω–∏–µ OFF –∏–ª–∏ —Ä–µ–∂–∏–º –Ω–µ home ‚Üí –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
          - conditions:
              - condition: or
                conditions:
                  - condition: state
                    entity_id: switch.humidifier_puh_9105_puh_2709_power
                    state: "off"
                  - condition: template
                    value_template: >
                      {{ state_attr('humidifier.humidifier_puh_9105_puh_2709_humidifier', 'mode') != 'home' }}
            sequence:
              - stop: "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤—ã–∫–ª—é—á–µ–Ω–æ –∏–ª–∏ —Ä–µ–∂–∏–º –Ω–µ home"

          # –ï—Å–ª–∏ –±–∞–∫ –ø—É—Å—Ç ‚Üí –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç –¥—Ä—É–≥–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∞)
          - conditions:
              - condition: state
                entity_id: binary_sensor.humidifier_puh_9105_puh_2709_water_tank
                state: "on"
            sequence:
              - stop: "–ù–µ—Ç –≤–æ–¥—ã –≤ –±–∞–∫–µ"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–ù–°–ò–í–ù–û–°–¢–¨–Æ
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # –°—Ç–∞–≤–∏–º –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ —Ä–µ–∞–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
      - condition: template
        value_template: "{{ recommended != current }}"

      # –ò –Ω–µ —á–∞—â–µ –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–∞ –≤ 5 –º–∏–Ω—É—Ç
      - condition: template
        value_template: >
          {{ (now() - states.number.humidifier_puh_9105_puh_2709_intensity.last_changed).total_seconds() > 300 }}

      # –û—Ç–∫–ª—é—á–∏—Ç—å –¥–µ—Ç–µ–∫—Ç–æ—Ä, —á—Ç–æ–±—ã –Ω–µ –ø–æ–π–º–∞—Ç—å —Å–≤–æ–∏ –∂–µ –¥–µ–π—Å—Ç–≤–∏—è
      - service: automation.turn_off
        target:
          entity_id: automation.humidity_manual_override_detector

      - service: number.set_value
        target:
          entity_id: number.humidifier_puh_9105_puh_2709_intensity
        data:
          value: "{{ recommended }}"

      # –ü–æ–¥–æ–∂–¥–∞—Ç—å MQTT‚Äë–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      - delay:
          seconds: 20

      # –í–∫–ª—é—á–∏—Ç—å –¥–µ—Ç–µ–∫—Ç–æ—Ä –æ–±—Ä–∞—Ç–Ω–æ
      - service: automation.turn_on
        target:
          entity_id: automation.humidity_manual_override_detector

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  #  –î–ï–¢–ï–ö–¢–û–† –†–£–ß–ù–û–ì–û –£–ü–†–ê–í–õ–ï–ù–ò–Ø (MANUAL override)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  - id: humidity_manual_override_detector
    alias: humidity_manual_override_detector
    mode: restart
    initial_state: true

    trigger:
      # –õ—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      - platform: state
        entity_id:
          - number.humidifier_puh_9105_puh_2709_intensity
          - switch.humidifier_puh_9105_puh_2709_power
          - switch.humidifier_puh_9105_puh_2709_warm_stream
          - switch.humidifier_puh_9105_puh_2709_backlight
          - switch.humidifier_puh_9105_puh_2709_ioniser
          - switch.humidifier_puh_9105_puh_2709_sound
        for:
          seconds: 2

      - platform: state
        entity_id: humidifier.humidifier_puh_9105_puh_2709_humidifier
        attribute: mode
        for:
          seconds: 2

    condition:
      # –ó–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
      - condition: template
        value_template: >
          {{ trigger.from_state is not none and trigger.to_state is not none
             and trigger.from_state.state != trigger.to_state.state }}

      # –ù–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è entity
      - condition: template
        value_template: >
          {{ trigger.from_state.state not in ['unavailable', 'unknown', 'none'] }}

      # –ù–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å, –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è control_main –∏–ª–∏ device_setup
      - condition: template
        value_template: >
          {{ state_attr('automation.humidity_control_main', 'current') | int(0) == 0 and
             state_attr('automation.humidity_device_setup', 'current') | int(0) == 0 }}

    action:
      # –ü–µ—Ä–µ—Ö–æ–¥ –≤ MANUAL: –æ—Ç–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—É—é –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º
      - service: automation.turn_off
        target:
          entity_id: automation.humidity_control_main

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  #  –£–í–ï–î–û–ú–õ–ï–ù–ò–ï: –û–®–ò–ë–ö–ê –£–°–¢–†–û–ô–°–¢–í–ê
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  - id: humidity_device_error
    alias: humidity_device_error
    mode: single
    initial_state: true

    trigger:
      - platform: state
        entity_id: sensor.humidifier_puh_9105_puh_2709_error

    condition:
      - condition: template
        value_template: >
          {% set err = trigger.to_state.state %}
          {{ err not in ['00', 'no_error', '02', 'child_lock', '', 'unknown', 'unavailable'] }}

    action:
      - variables:
          error_code: "{{ states('sensor.humidifier_puh_9105_puh_2709_error') }}"
          error_title: >
            {% if error_code in ['01', 'low_water'] %}
              üíß –ú–∞–ª–æ –≤–æ–¥—ã –≤ —É–≤–ª–∞–∂–Ω–∏—Ç–µ–ª–µ
            {% elif error_code in ['03', 'replace_filter'] %}
              üîß –ó–∞–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä —É–≤–ª–∞–∂–Ω–∏—Ç–µ–ª—è
            {% elif error_code in ['04', 'maximum_schedules'] %}
              ‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
            {% elif error_code in ['05', 'clean_tank'] %}
              üßº –û—á–∏—Å—Ç–∏—Ç–µ –±–∞–∫ —É–≤–ª–∞–∂–Ω–∏—Ç–µ–ª—è
            {% else %}
              ‚ö†Ô∏è –û—à–∏–±–∫–∞ —É–≤–ª–∞–∂–Ω–∏—Ç–µ–ª—è
            {% endif %}
          error_message: >
            {% if error_code in ['01', 'low_water'] %}
              –£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π.
              –ù–∞–ø–æ–ª–Ω–∏—Ç–µ –±–∞–∫ —á–∏—Å—Ç–æ–π –≤–æ–¥–æ–π.
            {% elif error_code in ['03', 'replace_filter'] %}
              –§–∏–ª—å—Ç—Ä –∑–∞–≥—Ä—è–∑–Ω—ë–Ω –∏ —Ç—Ä–µ–±—É–µ—Ç –∑–∞–º–µ–Ω—ã.
              –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã.

              –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –¥–æ –∑–∞–º–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä–∞.
            {% elif error_code in ['04', 'maximum_schedules'] %}
              –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π.
              –£–¥–∞–ª–∏—Ç–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
            {% elif error_code in ['05', 'clean_tank'] %}
              –ë–∞–∫ —Ç—Ä–µ–±—É–µ—Ç –æ—á–∏—Å—Ç–∫–∏ –æ—Ç –Ω–∞–∫–∏–ø–∏ –∏ –±–∞–∫—Ç–µ—Ä–∏–π.
              –í—ã–ø–æ–ª–Ω–∏—Ç–µ –æ—á–∏—Å—Ç–∫—É —Å–æ–≥–ª–∞—Å–Ω–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.

              –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –¥–æ –æ—á–∏—Å—Ç–∫–∏ –±–∞–∫–∞.
            {% else %}
              –ö–æ–¥ –æ—à–∏–±–∫–∏: {{ error_code }}
              –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
            {% endif %}

      - service: notify.zapgroup
        data:
          title: "{{ error_title }}"
          message: >
            {{ error_message }}

            –¢–µ–∫—É—â–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å: {{ states('sensor.sensor_eva_humidity') }}%
            –¶–µ–ª–µ–≤–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å: {{ states('sensor.adaptive_target_humidity') }}%