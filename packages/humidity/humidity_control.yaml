# package: puh_9105_humidity
# Version: 3.0.0
# Last Updated: 2025-01-27
# Changes: Added PD-controller with predictive damping (no configuration.yaml needed)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#  INPUT NUMBERS (–∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ –±–∞–∫–∞)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

input_number:
  humidifier_tank_capacity_ml:
    name: "Humidifier Tank Capacity (fixed)"
    min: 2000
    max: 8000
    step: 100
    initial: 5000
    unit_of_measurement: "ml"
    mode: box

  humidifier_calibration_cycles:
    name: "Humidifier Rate Calibration Cycles"
    min: 0
    max: 20
    step: 1
    initial: 0
    mode: box

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#  INPUT TEXT (per-level calibration data, persisted as JSON)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

input_text:
  humidifier_consumption_rates:
    name: "Humidifier Per-Level Consumption Rates (ml/h JSON)"
    max: 255
    initial: '{"1":71.4,"2":142.9,"3":214.3,"4":285.7,"5":357.1,"6":428.6,"7":500.0}'

  humidifier_last_calibration:
    name: "Humidifier Last Calibration Result (JSON)"
    max: 255
    initial: '{"correction":1.0,"model_ml":0,"cycle":0,"timestamp":""}'

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#  INPUT DATETIME (–Ω–∞—á–∞–ª–æ —Ü–∏–∫–ª–∞ –¥–ª—è history_stats)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

input_datetime:
  humidifier_cycle_start:
    name: "Humidifier Cycle Start Time"
    has_date: true
    has_time: true

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#  HISTORY STATS ‚Äî –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –Ω–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ –∑–∞ —Ç–µ–∫—É—â–∏–π —Ü–∏–∫–ª
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

sensor:
  - platform: history_stats
    name: "Humidifier Level 1 Hours"
    entity_id: number.humidifier_puh_9105_puh_2709_intensity
    state: "1"
    type: time
    start: >
      {{ states('input_datetime.humidifier_cycle_start') | as_datetime | default(today_at('00:00'), true) }}
    end: "{{ now() }}"

  - platform: history_stats
    name: "Humidifier Level 2 Hours"
    entity_id: number.humidifier_puh_9105_puh_2709_intensity
    state: "2"
    type: time
    start: >
      {{ states('input_datetime.humidifier_cycle_start') | as_datetime | default(today_at('00:00'), true) }}
    end: "{{ now() }}"

  - platform: history_stats
    name: "Humidifier Level 3 Hours"
    entity_id: number.humidifier_puh_9105_puh_2709_intensity
    state: "3"
    type: time
    start: >
      {{ states('input_datetime.humidifier_cycle_start') | as_datetime | default(today_at('00:00'), true) }}
    end: "{{ now() }}"

  - platform: history_stats
    name: "Humidifier Level 4 Hours"
    entity_id: number.humidifier_puh_9105_puh_2709_intensity
    state: "4"
    type: time
    start: >
      {{ states('input_datetime.humidifier_cycle_start') | as_datetime | default(today_at('00:00'), true) }}
    end: "{{ now() }}"

  - platform: history_stats
    name: "Humidifier Level 5 Hours"
    entity_id: number.humidifier_puh_9105_puh_2709_intensity
    state: "5"
    type: time
    start: >
      {{ states('input_datetime.humidifier_cycle_start') | as_datetime | default(today_at('00:00'), true) }}
    end: "{{ now() }}"

  - platform: history_stats
    name: "Humidifier Level 6 Hours"
    entity_id: number.humidifier_puh_9105_puh_2709_intensity
    state: "6"
    type: time
    start: >
      {{ states('input_datetime.humidifier_cycle_start') | as_datetime | default(today_at('00:00'), true) }}
    end: "{{ now() }}"

  - platform: history_stats
    name: "Humidifier Level 7 Hours"
    entity_id: number.humidifier_puh_9105_puh_2709_intensity
    state: "7"
    type: time
    start: >
      {{ states('input_datetime.humidifier_cycle_start') | as_datetime | default(today_at('00:00'), true) }}
    end: "{{ now() }}"

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#  TEMPLATE SENSORS
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

template:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  #  –ë–õ–û–ö 1: –†–ê–°–ß–Å–¢ –°–ö–û–†–û–°–¢–ò –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í–õ–ê–ñ–ù–û–°–¢–ò (–∑–∞–º–µ–Ω–∞ derivative sensor)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  - trigger:
      - platform: time_pattern
        minutes: "/1"
      - platform: homeassistant
        event: start
    sensor:
      - name: "Humidity Rate"
        unique_id: humidity_rate
        unit_of_measurement: "%/min"
        state_class: measurement
        icon: mdi:trending-up
        state: >
          {% set current = states('sensor.sensor_eva_humidity') | float(none) %}
          {% if current is none %}
            {{ this.state | default(0) }}
          {% else %}
            {# –ë–µ—Ä—ë–º –∑–Ω–∞—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥ (5 —à–∞–≥–æ–≤ √ó 1 –º–∏–Ω) #}
            {% set old = this.attributes.h5 | default(current) | float(current) %}
            {% set rate = (current - old) / 5 %}
            {# EMA —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —à—É–º–∞ #}
            {% set prev_rate = this.state | float(0) %}
            {{ (0.4 * rate + 0.6 * prev_rate) | round(3) }}
          {% endif %}
        attributes:
          # –ö–æ–ª—å—Ü–µ–≤–æ–π –±—É—Ñ–µ—Ä: –∫–∞–∂–¥—É—é 1 –º–∏–Ω —Å–¥–≤–∏–≥–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
          h1: "{{ states('sensor.sensor_eva_humidity') | float(0) }}"
          h2: "{{ this.attributes.h1 | default(states('sensor.sensor_eva_humidity')) | float(0) }}"
          h3: "{{ this.attributes.h2 | default(states('sensor.sensor_eva_humidity')) | float(0) }}"
          h4: "{{ this.attributes.h3 | default(states('sensor.sensor_eva_humidity')) | float(0) }}"
          h5: "{{ this.attributes.h4 | default(states('sensor.sensor_eva_humidity')) | float(0) }}"
          current_humidity: "{{ states('sensor.sensor_eva_humidity') | float(0) }}"
          minutes_window: 5

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  #  –ë–õ–û–ö 2: –û–°–ù–û–í–ù–´–ï –°–ï–ù–°–û–†–´ (—Ü–µ–ª—å, –æ—à–∏–±–∫–∞, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  - trigger:
      - platform: state
        entity_id: sensor.sensor_eva_humidity
      - platform: state
        entity_id: sensor.sensor_eva_temperature
      - platform: state
        entity_id: weather.forecast_home_assistant
        attribute: temperature
      - platform: state
        entity_id: sensor.humidity_rate
      - platform: time_pattern
        minutes: "/1"
    sensor:
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      #  –ê–î–ê–ü–¢–ò–í–ù–ê–Ø –¶–ï–õ–ï–í–ê–Ø –í–õ–ê–ñ–ù–û–°–¢–¨
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "Adaptive Target Humidity"
        unique_id: adaptive_target_humidity
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:water-thermometer-outline
        availability: >
          {{ has_value('sensor.sensor_eva_temperature') and
             has_value('weather.forecast_home_assistant') }}
        state: >
          {% set T_room = states('sensor.sensor_eva_temperature') | float(22) %}
          {% set T_outdoor = state_attr('weather.forecast_home_assistant', 'temperature') | float(0) %}
          {% set base_indoor = 75 - (1.25 * T_room) %}
          {% set outdoor_limit = 50 - [0, 10 - T_outdoor] | max %}
          {% set target = [base_indoor, outdoor_limit, 60] | min | float %}
          {% set target = [target, 40] | max %}
          {{ target | round(1) }}

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      #  –û–®–ò–ë–ö–ê –†–ï–ì–£–õ–ò–†–û–í–ê–ù–ò–Ø
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "Humidity Error"
        unique_id: humidity_error
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:delta
        availability: >
          {{ has_value('sensor.adaptive_target_humidity') and
             has_value('sensor.sensor_eva_humidity') }}
        state: >
          {% set target = states('sensor.adaptive_target_humidity') | float(45) %}
          {% set current = states('sensor.sensor_eva_humidity') | float(50) %}
          {{ (target - current) | round(1) }}

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      #  PD-–†–ï–ì–£–õ–Ø–¢–û–†: –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–ê–Ø –ò–ù–¢–ï–ù–°–ò–í–ù–û–°–¢–¨
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "Recommended Intensity"
        unique_id: humidity_recommended_intensity
        icon: mdi:gauge
        availability: >
          {{ has_value('sensor.humidity_error') and
             has_value('sensor.humidity_rate') and
             has_value('number.humidifier_puh_9105_puh_2709_intensity') }}
        state: >
          {% set error = states('sensor.humidity_error') | float(0) %}
          {% set rate = states('sensor.humidity_rate') | float(0) %}
          {% set current = states('number.humidifier_puh_9105_puh_2709_intensity') | int(0) %}
          
          {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
             –ù–ê–°–¢–†–ê–ò–í–ê–ï–ú–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ PD-–†–ï–ì–£–õ–Ø–¢–û–†–ê
             ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
          {% set PREDICTION_MINUTES = 7 %}
          {% set DEADBAND = 2.0 %}
          
          {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
             –ü–†–û–ì–ù–û–ó –û–®–ò–ë–ö–ò
             
             –ï—Å–ª–∏ error=+5% –∏ rate=+0.5%/–º–∏–Ω:
             predicted = 5 - 0.5√ó7 = 1.5%
             ‚Üí —á–µ—Ä–µ–∑ 7 –º–∏–Ω –±—É–¥–µ–º –ø–æ—á—Ç–∏ –≤ —Ü–µ–ª–∏ ‚Üí —Ç–æ—Ä–º–æ–∑–∏–º —Å–µ–π—á–∞—Å!
             ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
          {% set predicted_error = error - (rate * PREDICTION_MINUTES) %}
          
          {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
             –ê–î–ê–ü–¢–ò–í–ù–û–ï –î–ï–ú–ü–§–ò–†–û–í–ê–ù–ò–ï
             –ß–µ–º –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–∏–±–ª–∏–∂–∞–µ–º—Å—è –∫ —Ü–µ–ª–∏ ‚Äî —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Ç–æ—Ä–º–æ–∑–∏–º
             ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
          {% set damping = 0 %}
          
          {# –†–∞—Å—Ç—ë–º –∫ —Ü–µ–ª–∏ (–Ω–µ–¥–æ—É–≤–ª–∞–∂–Ω–µ–Ω–∏–µ + –≤–ª–∞–∂–Ω–æ—Å—Ç—å —Ä–∞—Å—Ç—ë—Ç) #}
          {% if error > 0 and rate > 0.15 %}
            {% if error < 2 and rate > 0.3 %}
              {% set damping = 3 %}
            {% elif error < 3 and rate > 0.4 %}
              {% set damping = 2 %}
            {% elif error < 4 and rate > 0.3 %}
              {% set damping = 2 %}
            {% elif error < 6 and rate > 0.3 %}
              {% set damping = 1 %}
            {% elif error < 8 and rate > 0.5 %}
              {% set damping = 1 %}
            {% endif %}
          {% endif %}
          
          {# –ü–∞–¥–∞–µ–º –∫ —Ü–µ–ª–∏ (–ø–µ—Ä–µ—É–≤–ª–∞–∂–Ω–µ–Ω–∏–µ + –≤–ª–∞–∂–Ω–æ—Å—Ç—å –ø–∞–¥–∞–µ—Ç) #}
          {% if error < 0 and rate < -0.15 %}
            {% if error > -2 and rate < -0.3 %}
              {% set damping = -1 %}
            {% elif error > -3 and rate < -0.2 %}
              {% set damping = -1 %}
            {% endif %}
          {% endif %}
          
          {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
             –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ë–ê–ó–û–í–û–ô –ò–ù–¢–ï–ù–°–ò–í–ù–û–°–¢–ò –ü–û –ü–†–û–ì–ù–û–ó–£
             –ù–µ–¥–æ—É–≤–ª–∞–∂–Ω–µ–Ω–∏–µ ‚Üí –º–∞–∫—Å–∏–º—É–º. –ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ ‚Üí –ø–ª–∞–≤–Ω–æ.
             ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
          {% if predicted_error > DEADBAND %}
            {% set target_intensity = 7 %}
            
          {# --- –ó–û–ù–ê –°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–ò --- #}
          {% elif predicted_error >= -DEADBAND %}
            {% if current <= 2 %}
              {% set target_intensity = current %}
            {% elif predicted_error < 0 %}
              {% set target_intensity = [current - 1, 1] | max %}
            {% else %}
              {% set target_intensity = current %}
            {% endif %}
            
          {# --- –ü–ï–†–ï–£–í–õ–ê–ñ–ù–ï–ù–ò–ï --- #}
          {% elif predicted_error > -4 %}
            {% set target_intensity = 1 %}
          {% elif predicted_error > -6 %}
            {% set target_intensity = 0 %}
          {% else %}
            {% set target_intensity = 0 %}
          {% endif %}
          
          {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
             –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –î–ï–ú–ü–§–ò–†–û–í–ê–ù–ò–Ø
             ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
          {% set target_intensity = target_intensity - damping %}
          {% set target_intensity = [target_intensity, 0] | max %}
          {% set target_intensity = [target_intensity, 7] | min %}
          
           {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
              –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –°–ö–û–†–û–°–¢–ò –ò–ó–ú–ï–ù–ï–ù–ò–Ø (+3 –≤–≤–µ—Ä—Ö / -2 –≤–Ω–∏–∑)
              ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
           {% if target_intensity > current + 3 %}
             {% set target_intensity = current + 3 %}
           {% elif target_intensity < current - 2 %}
             {% set target_intensity = current - 2 %}
           {% endif %}
           
           {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
              –ê–ù–¢–ò–û–°–¶–ò–õ–õ–Ø–¶–ò–Ø: –µ—Å–ª–∏ –≤ –∑–æ–Ω–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ
              5 —à–∞–≥–æ–≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—è–ª–æ—Å—å ‚â•3 —Ä–∞–∑ ‚Üí –¥–µ—Ä–∂–∏–º —Ç–µ–∫—É—â–µ–µ
              ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
           {% set in_stability = (predicted_error >= -DEADBAND and predicted_error <= DEADBAND) %}
           {% if in_stability and target_intensity != current %}
             {% set h = [
               this.attributes.i1 | default(current) | int,
               this.attributes.i2 | default(current) | int,
               this.attributes.i3 | default(current) | int,
               this.attributes.i4 | default(current) | int,
               this.attributes.i5 | default(current) | int
             ] %}
             {% set ns = namespace(changes=0) %}
             {% for i in range(1, h | length) %}
               {% if h[i] != h[i-1] %}
                 {% set ns.changes = ns.changes + 1 %}
               {% endif %}
             {% endfor %}
             {% if ns.changes >= 3 %}
               {% set target_intensity = current %}
             {% endif %}
           {% endif %}
           
           {{ target_intensity | int }}
          
        attributes:
          error: "{{ states('sensor.humidity_error') | float(0) }}"
          rate: "{{ states('sensor.humidity_rate') | float(0) }}"
          predicted_error: >
            {% set error = states('sensor.humidity_error') | float(0) %}
            {% set rate = states('sensor.humidity_rate') | float(0) %}
            {{ (error - (rate * 7)) | round(1) }}
          damping: >
            {% set error = states('sensor.humidity_error') | float(0) %}
            {% set rate = states('sensor.humidity_rate') | float(0) %}
            {% set d = 0 %}
            {% if error > 0 and rate > 0.15 %}
              {% if error < 2 and rate > 0.3 %}
                {% set d = 3 %}
              {% elif error < 3 and rate > 0.4 %}
                {% set d = 2 %}
              {% elif error < 4 and rate > 0.3 %}
                {% set d = 2 %}
              {% elif error < 6 and rate > 0.3 %}
                {% set d = 1 %}
              {% elif error < 8 and rate > 0.5 %}
                {% set d = 1 %}
              {% endif %}
            {% elif error < 0 and rate < -0.15 %}
              {% if error > -2 and rate < -0.3 %}
                {% set d = -1 %}
              {% elif error > -3 and rate < -0.2 %}
                {% set d = -1 %}
              {% endif %}
            {% endif %}
            {{ d }}
          control_mode: >
            {% set error = states('sensor.humidity_error') | float(0) %}
            {% set rate = states('sensor.humidity_rate') | float(0) %}
            {% set predicted = error - (rate * 7) %}
            {% if predicted > 2 %}
              humidifying
            {% elif predicted < -2 %}
              drying
            {% else %}
              stable
            {% endif %}
          # –ö–æ–ª—å—Ü–µ–≤–æ–π –±—É—Ñ–µ—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 –∑–Ω–∞—á–µ–Ω–∏–π –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ (–¥–ª—è –∞–Ω—Ç–∏–æ—Å—Ü–∏–ª–ª—è—Ü–∏–∏)
          i1: "{{ this.state | default(0) | int }}"
          i2: "{{ this.attributes.i1 | default(0) | int }}"
          i3: "{{ this.attributes.i2 | default(0) | int }}"
          i4: "{{ this.attributes.i3 | default(0) | int }}"
          i5: "{{ this.attributes.i4 | default(0) | int }}"
          flapping: >
            {% set h = [
              this.attributes.i1 | default(0) | int,
              this.attributes.i2 | default(0) | int,
              this.attributes.i3 | default(0) | int,
              this.attributes.i4 | default(0) | int,
              this.attributes.i5 | default(0) | int
            ] %}
            {% set ns = namespace(changes=0) %}
            {% for i in range(1, h | length) %}
              {% if h[i] != h[i-1] %}
                {% set ns.changes = ns.changes + 1 %}
              {% endif %}
            {% endfor %}
            {{ ns.changes }}
          # –ü–µ—Ä–µ–ª—ë—Ç: —Ç–µ–∫—É—â–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å –≤—ã—à–µ —Ü–µ–ª–∏ (overshoot)
          overshoot: >
            {% set error = states('sensor.humidity_error') | float(0) %}
            {{ error < -1.0 }}
          overshoot_pct: >
            {% set error = states('sensor.humidity_error') | float(0) %}
            {{ ([0, -error] | max) | round(1) }}

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  #  –ë–õ–û–ö 3: –í–ò–†–¢–£–ê–õ–¨–ù–´–ô –°–ï–ù–°–û–† –£–†–û–í–ù–Ø –í–û–î–´ (–∞–≤—Ç–æ–∫–∞–ª–∏–±—Ä–æ–≤–∫–∞)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  - trigger:
      # –¢–∏–∫ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –¥–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞
      - platform: time_pattern
        minutes: "/1"
        id: "tick"
      # –ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–∑–∞–ø—Ä–∞–≤–∫–∞ / –æ–ø—É—Å—Ç–æ—à–µ–Ω–∏–µ)
      - platform: state
        entity_id: sensor.humidifier_puh_9105_puh_2709_error
        id: "error_change"
      # –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏—è
      - platform: state
        entity_id: switch.humidifier_puh_9105_puh_2709_power
        id: "power_change"
      # –°–Ω—è—Ç–∏–µ –±–∞–∫–∞
      - platform: state
        entity_id: binary_sensor.humidifier_puh_9105_puh_2709_water_tank
        id: "tank_change"
    sensor:
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      #  –ù–ê–ö–û–ü–õ–ï–ù–ù–´–ô –†–ê–°–•–û–î –í–û–î–´ (–º–ª) ‚Äî —Å –∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Å—Ç–∞–≤–∫–∞–º–∏ per-level
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "Humidifier Water Consumed"
        unique_id: humidifier_water_consumed_ml
        unit_of_measurement: "ml"
        state_class: total
        icon: mdi:water-minus
        state: >
          {% set current = this.state | float(0) %}
          {% if trigger is not defined %}
            {{ current }}
          {% else %}
            {% set error = states('sensor.humidifier_puh_9105_puh_2709_error') %}
            {% set prev_error = trigger.from_state.state if trigger.id == 'error_change' else none %}
            {% set tank_removed = is_state('binary_sensor.humidifier_puh_9105_puh_2709_water_tank', 'on') %}
            {% set power_on = is_state('switch.humidifier_puh_9105_puh_2709_power', 'on') %}
            {% set intensity = states('number.humidifier_puh_9105_puh_2709_intensity') | int(0) %}
            
            {# –ó–∞–ø—Ä–∞–≤–∫–∞: –æ—à–∏–±–∫–∞ –≤–æ–¥—ã —É—à–ª–∞ ‚Üí –±–∞–∫ –Ω–∞–ø–æ–ª–Ω–µ–Ω ‚Üí —Å–±—Ä–æ—Å #}
            {% if trigger.id == 'error_change'
               and prev_error in ['low_water', '01']
               and error in ['no_error', '00', '02', 'child_lock'] %}
              {{ 0 }}
            {# –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ: —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Ä–∞–±–æ—Ç–∞–µ—Ç #}
            {% elif trigger.id == 'tick'
                and power_on
                and not tank_removed
                and error in ['no_error', '00', '02', 'child_lock']
                and intensity > 0 %}
              {# –ö–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞–≤–∫–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è (–º–ª/—á) #}
              {% set rates_raw = states('input_text.humidifier_consumption_rates') %}
              {% set defaults = {"1":71.4,"2":142.9,"3":214.3,"4":285.7,"5":357.1,"6":428.6,"7":500.0} %}
              {% set rates = rates_raw | from_json if rates_raw not in ['unknown','unavailable',''] else defaults %}
              {% set level_key = intensity | string %}
              {% set rate_ml_h = (rates[level_key] | default(intensity * 500.0 / 7.0)) | float %}
              {% set rate_ml_per_min = rate_ml_h / 60.0 %}
              {{ (current + rate_ml_per_min) | round(1) }}
            {% else %}
              {{ current }}
            {% endif %}
          {% endif %}

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      #  –£–†–û–í–ï–ù–¨ –í–û–î–´ –í –ë–ê–ö–ï (%)
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "Humidifier Water Level"
        unique_id: humidifier_water_level_pct
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:water-percent
        state: >
          {% set capacity = states('input_number.humidifier_tank_capacity_ml') | float(5000) %}
          {% set consumed = states('sensor.humidifier_water_consumed') | float(0) %}
          {{ [0, (((capacity - consumed) / capacity) * 100)] | max | round(0) }}
        attributes:
          capacity_ml: "{{ states('input_number.humidifier_tank_capacity_ml') | float(5000) | round(0) }}"
          consumed_ml: "{{ states('sensor.humidifier_water_consumed') | float(0) | round(0) }}"
          remaining_ml: >
            {% set capacity = states('input_number.humidifier_tank_capacity_ml') | float(5000) %}
            {% set consumed = states('sensor.humidifier_water_consumed') | float(0) %}
            {{ [0, (capacity - consumed)] | max | round(0) }}
          hours_remaining: >
            {% set capacity = states('input_number.humidifier_tank_capacity_ml') | float(5000) %}
            {% set consumed = states('sensor.humidifier_water_consumed') | float(0) %}
            {% set intensity = states('number.humidifier_puh_9105_puh_2709_intensity') | int(0) %}
            {% if intensity > 0 %}
              {% set rates_raw = states('input_text.humidifier_consumption_rates') %}
              {% set defaults = {"1":71.4,"2":142.9,"3":214.3,"4":285.7,"5":357.1,"6":428.6,"7":500.0} %}
              {% set rates = rates_raw | from_json if rates_raw not in ['unknown','unavailable',''] else defaults %}
              {% set rate = (rates[intensity | string] | default(intensity * 500.0 / 7.0)) | float %}
              {{ (([0, (capacity - consumed)] | max) / rate) | round(1) }}
            {% else %}
              unknown
            {% endif %}
          calibration_cycles: "{{ states('input_number.humidifier_calibration_cycles') | int(0) }}"
          consumption_rates: "{{ states('input_text.humidifier_consumption_rates') }}"
          last_calibration: "{{ states('input_text.humidifier_last_calibration') }}"
          level_hours: >
            {{ {
              "1": states('sensor.humidifier_level_1_hours') | float(0),
              "2": states('sensor.humidifier_level_2_hours') | float(0),
              "3": states('sensor.humidifier_level_3_hours') | float(0),
              "4": states('sensor.humidifier_level_4_hours') | float(0),
              "5": states('sensor.humidifier_level_5_hours') | float(0),
              "6": states('sensor.humidifier_level_6_hours') | float(0),
              "7": states('sensor.humidifier_level_7_hours') | float(0)
            } }}

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#  SCRIPTS
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

script:
  humidity_auto_resume:
    alias: "–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ‚Äë—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–ª–∞–∂–Ω–∏—Ç–µ–ª–µ–º"
    mode: single
    sequence:
      - service: automation.turn_on
        target:
           entity_id:
            - automation.humidity_control_main
            - automation.humidity_mode_enforcer

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#  AUTOMATIONS
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

automation:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  #  –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –£–°–¢–†–û–ô–°–¢–í–ê
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  - id: humidity_device_setup
    alias: humidity_device_setup
    mode: single
    max_exceeded: silent
    initial_state: true

    trigger:
      - platform: state
        entity_id: automation.humidity_control_main
        to: "on"
      - platform: homeassistant
        event: start

    condition:
      - condition: state
        entity_id: automation.humidity_control_main
        state: "on"

    action:
      - service: switch.turn_on
        target:
          entity_id: switch.humidifier_puh_9105_puh_2709_power

      - delay:
          seconds: 2

      - service: humidifier.set_mode
        target:
          entity_id: humidifier.humidifier_puh_9105_puh_2709_humidifier
        data:
          mode: "home"

      - service: humidifier.set_humidity
        target:
          entity_id: humidifier.humidifier_puh_9105_puh_2709_humidifier
        data:
          humidity: 75

      - service: switch.turn_off
        target:
          entity_id:
            - switch.humidifier_puh_9105_puh_2709_sound
            - switch.humidifier_puh_9105_puh_2709_backlight
      - service: switch.turn_on
        target:
          entity_id:
            - switch.humidifier_puh_9105_puh_2709_child_lock
            - switch.humidifier_puh_9105_puh_2709_ioniser
            - switch.humidifier_puh_9105_puh_2709_warm_stream

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  #  –ö–û–ù–¢–†–û–õ–¨ –†–ï–ñ–ò–ú–ê
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  - id: humidity_mode_enforcer
    alias: humidity_mode_enforcer
    description: "–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ä–µ–∂–∏–º 'home' –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏"
    mode: single
    max_exceeded: silent
    initial_state: true

    trigger:
      - platform: state
        entity_id: humidifier.humidifier_puh_9105_puh_2709_humidifier
        attribute: mode
        id: "mode_changed"
      - platform: state
        entity_id: switch.humidifier_puh_9105_puh_2709_power
        to: "on"
        for:
          seconds: 2
        id: "power_on"
      - platform: time_pattern
        minutes: "/2"
        id: "periodic"
      - platform: homeassistant
        event: start
        id: "ha_start"

    condition:
      - condition: state
        entity_id: automation.humidity_control_main
        state: "on"
      - condition: state
        entity_id: switch.humidifier_puh_9105_puh_2709_power
        state: "on"
      - condition: template
        value_template: >
          {{ state_attr('humidifier.humidifier_puh_9105_puh_2709_humidifier', 'mode') != 'home' }}

    action:
      - delay:
          seconds: 1

      - service: humidifier.set_mode
        target:
          entity_id: humidifier.humidifier_puh_9105_puh_2709_humidifier
        data:
          mode: "home"

      - delay:
          seconds: 2

      - if:
          - condition: template
            value_template: "{{ trigger.id == 'power_on' }}"
        then:
          - service: humidifier.set_mode
            target:
              entity_id: humidifier.humidifier_puh_9105_puh_2709_humidifier
            data:
              mode: "home"
          - delay:
              seconds: 2

      - service: humidifier.set_humidity
        target:
          entity_id: humidifier.humidifier_puh_9105_puh_2709_humidifier
        data:
          humidity: 75

      - service: number.set_value
        target:
          entity_id: number.humidifier_puh_9105_puh_2709_intensity
        data:
          value: "{{ states('sensor.recommended_intensity') | int(3) }}"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  #  –û–°–ù–û–í–ù–ê–Ø –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  - id: humidity_control_main
    alias: humidity_control_main
    mode: single
    max_exceeded: silent
    initial_state: true

    trigger:
      - platform: state
        entity_id: sensor.recommended_intensity

    condition:
      - condition: template
        value_template: >
          {% set err = states('sensor.humidifier_puh_9105_puh_2709_error') %}
          {{ err in ['00', 'no_error', '02', 'child_lock', '', 'unknown', 'unavailable'] }}

    action:
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞
      - if:
          - condition: state
            entity_id: switch.humidifier_puh_9105_puh_2709_power
            state: "on"
          - condition: template
            value_template: >
              {{ state_attr('humidifier.humidifier_puh_9105_puh_2709_humidifier', 'mode') != 'home' }}
        then:
          - service: humidifier.set_mode
            target:
              entity_id: humidifier.humidifier_puh_9105_puh_2709_humidifier
            data:
              mode: "home"
          - delay:
              seconds: 3

      # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
      - variables:
          recommended: "{{ states('sensor.recommended_intensity') | int(0) }}"
          current: "{{ states('number.humidifier_puh_9105_puh_2709_intensity') | int(0) }}"

      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏–µ–º
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ recommended == 0 }}"
              - condition: template
                value_template: "{{ states('switch.humidifier_puh_9105_puh_2709_power') == 'on' }}"
            sequence:
              - service: switch.turn_off
                target:
                  entity_id: switch.humidifier_puh_9105_puh_2709_power
              - delay:
                  seconds: 2

          - conditions:
              - condition: template
                value_template: "{{ recommended > 0 }}"
              - condition: template
                value_template: "{{ states('switch.humidifier_puh_9105_puh_2709_power') != 'on' }}"
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.humidifier_puh_9105_puh_2709_power
              - delay:
                  seconds: 3
              - service: humidifier.set_mode
                target:
                  entity_id: humidifier.humidifier_puh_9105_puh_2709_humidifier
                data:
                  mode: "home"
              - delay:
                  seconds: 2

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
      - choose:
          - conditions:
              - condition: or
                conditions:
                  - condition: state
                    entity_id: switch.humidifier_puh_9105_puh_2709_power
                    state: "off"
                  - condition: template
                    value_template: >
                      {{ state_attr('humidifier.humidifier_puh_9105_puh_2709_humidifier', 'mode') != 'home' }}
            sequence:
              - stop: "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤—ã–∫–ª—é—á–µ–Ω–æ –∏–ª–∏ —Ä–µ–∂–∏–º –Ω–µ home"

          - conditions:
              - condition: state
                entity_id: binary_sensor.humidifier_puh_9105_puh_2709_water_tank
                state: "on"
            sequence:
              - stop: "–ù–µ—Ç –≤–æ–¥—ã –≤ –±–∞–∫–µ"

      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å—é
      - condition: template
        value_template: "{{ recommended != current }}"

      - condition: template
        value_template: >
          {{ (now() - states.number.humidifier_puh_9105_puh_2709_intensity.last_changed).total_seconds() > 30 }}

      - service: number.set_value
        target:
          entity_id: number.humidifier_puh_9105_puh_2709_intensity
        data:
          value: "{{ recommended }}"

      - delay:
          seconds: 3

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  #  –ö–ê–õ–ò–ë–†–û–í–ö–ê –†–ê–°–•–û–î–ê PER-LEVEL (–ø—Ä–∏ –æ–ø—É—Å—Ç–æ—à–µ–Ω–∏–∏ –±–∞–∫–∞)
  #  –î–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ history_stats —Å–µ–Ω—Å–æ—Ä–æ–≤ (—á–∞—Å—ã –Ω–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  - id: humidifier_calibrate_rates
    alias: humidifier_calibrate_rates
    description: "–ê–≤—Ç–æ–∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ä–∞—Å—Ö–æ–¥–∞ –Ω–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ (history_stats)"
    mode: single
    initial_state: true

    trigger:
      - platform: state
        entity_id: sensor.humidifier_puh_9105_puh_2709_error
        to:
          - "low_water"
          - "01"

    condition:
      # –ö–∞–ª–∏–±—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–æ > 1 –ª–∏—Ç—Ä–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π)
      - condition: numeric_state
        entity_id: sensor.humidifier_water_consumed
        above: 1000

    action:
      - variables:
          capacity: "{{ states('input_number.humidifier_tank_capacity_ml') | float(5000) }}"
          model_consumed: "{{ states('sensor.humidifier_water_consumed') | float(0) }}"
          cycles: "{{ states('input_number.humidifier_calibration_cycles') | int(0) }}"
          capped_cycles: "{{ [cycles, 10] | min }}"
          correction: "{{ (capacity / model_consumed) | round(4) if model_consumed > 0 else 1.0 }}"
          rates_raw: "{{ states('input_text.humidifier_consumption_rates') }}"
          default_rates: {"1":71.4,"2":142.9,"3":214.3,"4":285.7,"5":357.1,"6":428.6,"7":500.0}
          # –ß–∞—Å—ã –Ω–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ –∏–∑ history_stats (–Ω–∞—Ç–∏–≤–Ω—ã–π HA)
          level_hours: >
            {%- set h = {
              "1": states('sensor.humidifier_level_1_hours') | float(0),
              "2": states('sensor.humidifier_level_2_hours') | float(0),
              "3": states('sensor.humidifier_level_3_hours') | float(0),
              "4": states('sensor.humidifier_level_4_hours') | float(0),
              "5": states('sensor.humidifier_level_5_hours') | float(0),
              "6": states('sensor.humidifier_level_6_hours') | float(0),
              "7": states('sensor.humidifier_level_7_hours') | float(0)
            } -%}
            {{ h | to_json }}
          # –ù–æ–≤—ã–µ —Å—Ç–∞–≤–∫–∏: EMA-–∫–æ—Ä—Ä–µ–∫—Ü–∏—è –¥–ª—è —É—Ä–æ–≤–Ω–µ–π —Å >6 –º–∏–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
          new_rates: >
            {%- set r = rates_raw | from_json if rates_raw not in ['unknown','unavailable',''] else default_rates -%}
            {%- set corr = (capacity / model_consumed) if model_consumed | float > 0 else 1.0 -%}
            {%- set cc = [cycles | int, 10] | min -%}
            {%- set h = {
              "1": states('sensor.humidifier_level_1_hours') | float(0),
              "2": states('sensor.humidifier_level_2_hours') | float(0),
              "3": states('sensor.humidifier_level_3_hours') | float(0),
              "4": states('sensor.humidifier_level_4_hours') | float(0),
              "5": states('sensor.humidifier_level_5_hours') | float(0),
              "6": states('sensor.humidifier_level_6_hours') | float(0),
              "7": states('sensor.humidifier_level_7_hours') | float(0)
            } -%}
            {%- set ns = namespace(result={}) -%}
            {%- for k in ['1','2','3','4','5','6','7'] -%}
              {%- set old_rate = r[k] | default(k | int * 500.0 / 7.0) | float -%}
              {%- set hrs = h[k] | float(0) -%}
              {%- if hrs > 0.1 -%}
                {%- set corrected = old_rate * corr -%}
                {%- set blended = ((old_rate * cc + corrected) / (cc + 1)) | round(1) -%}
                {%- set ns.result = dict(ns.result, **{k: blended}) -%}
              {%- else -%}
                {%- set ns.result = dict(ns.result, **{k: old_rate | round(1)}) -%}
              {%- endif -%}
            {%- endfor -%}
            {{ ns.result | to_json }}

      - service: input_text.set_value
        target:
          entity_id: input_text.humidifier_consumption_rates
        data:
          value: "{{ new_rates }}"

      - service: input_number.set_value
        target:
          entity_id: input_number.humidifier_calibration_cycles
        data:
          value: "{{ capped_cycles + 1 }}"

      # –°–±—Ä–æ—Å —Ü–∏–∫–ª–∞ ‚Äî history_stats –Ω–∞—á–Ω—ë—Ç —Å—á–∏—Ç–∞—Ç—å –∑–∞–Ω–æ–≤–æ
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.humidifier_cycle_start
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"

      # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
      - service: input_text.set_value
        target:
          entity_id: input_text.humidifier_last_calibration
        data:
          value: >
            {{ {"correction": correction | float | round(4),
                "model_ml": model_consumed | float | round(0),
                "cycle": (capped_cycles + 1) | int,
                "level_hours": level_hours | from_json,
                "timestamp": now().isoformat()} | to_json }}

      - service: notify.zapgroup
        data:
          title: "üìä –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ä–∞—Å—Ö–æ–¥–∞ —É–≤–ª–∞–∂–Ω–∏—Ç–µ–ª—è"
          message: >
            –ë–∞–∫ –æ–ø—É—Å—Ç–æ—à—ë–Ω ({{ capacity | round(0) }} –º–ª).
            –ú–æ–¥–µ–ª—å –Ω–∞—Å—á–∏—Ç–∞–ª–∞: {{ model_consumed | round(0) }} –º–ª.
            –ö–æ—Ä—Ä–µ–∫—Ü–∏—è: √ó{{ correction }}.
            –¶–∏–∫–ª: {{ capped_cycles + 1 }}.
            –ß–∞—Å—ã –ø–æ —É—Ä–æ–≤–Ω—è–º: {{ level_hours }}.
            –ù–æ–≤—ã–µ —Å—Ç–∞–≤–∫–∏ (–º–ª/—á): {{ new_rates }}.

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  #  –£–í–ï–î–û–ú–õ–ï–ù–ò–ï: –û–®–ò–ë–ö–ê –£–°–¢–†–û–ô–°–¢–í–ê
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  - id: humidity_device_error
    alias: humidity_device_error
    mode: single
    initial_state: true

    trigger:
      - platform: state
        entity_id: sensor.humidifier_puh_9105_puh_2709_error

    condition:
      # –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äî –æ—à–∏–±–∫–∞
      - condition: template
        value_template: >
          {% set err = trigger.to_state.state %}
          {{ err not in ['00', 'no_error', '02', 'child_lock', '', 'unknown', 'unavailable'] }}
      # –ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äî –ù–ï –æ—à–∏–±–∫–∞ (—Ç.–µ. —ç—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥ –≤ –æ—à–∏–±–∫—É, –∞ –Ω–µ –ø–æ–≤—Ç–æ—Ä)
      - condition: template
        value_template: >
          {% set prev = trigger.from_state.state %}
          {{ prev in ['00', 'no_error', '02', 'child_lock', '', 'unknown', 'unavailable'] }}

    action:
      - variables:
          error_code: "{{ trigger.to_state.state }}"
          error_title: >
            {% if error_code in ['01', 'low_water'] %}
              üíß –ú–∞–ª–æ –≤–æ–¥—ã –≤ —É–≤–ª–∞–∂–Ω–∏—Ç–µ–ª–µ
            {% elif error_code in ['03', 'replace_filter'] %}
              üîß –ó–∞–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä —É–≤–ª–∞–∂–Ω–∏—Ç–µ–ª—è
            {% elif error_code in ['04', 'maximum_schedules'] %}
              ‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
            {% elif error_code in ['05', 'clean_tank'] %}
              üßº –û—á–∏—Å—Ç–∏—Ç–µ –±–∞–∫ —É–≤–ª–∞–∂–Ω–∏—Ç–µ–ª—è
            {% else %}
              ‚ö†Ô∏è –û—à–∏–±–∫–∞ —É–≤–ª–∞–∂–Ω–∏—Ç–µ–ª—è
            {% endif %}
          error_message: >
            {% if error_code in ['01', 'low_water'] %}
              –£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π.
              –ù–∞–ø–æ–ª–Ω–∏—Ç–µ –±–∞–∫ —á–∏—Å—Ç–æ–π –≤–æ–¥–æ–π.
            {% elif error_code in ['03', 'replace_filter'] %}
              –§–∏–ª—å—Ç—Ä –∑–∞–≥—Ä—è–∑–Ω—ë–Ω –∏ —Ç—Ä–µ–±—É–µ—Ç –∑–∞–º–µ–Ω—ã.
            {% elif error_code in ['04', 'maximum_schedules'] %}
              –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π.
            {% elif error_code in ['05', 'clean_tank'] %}
              –ë–∞–∫ —Ç—Ä–µ–±—É–µ—Ç –æ—á–∏—Å—Ç–∫–∏ –æ—Ç –Ω–∞–∫–∏–ø–∏.
            {% else %}
              –ö–æ–¥ –æ—à–∏–±–∫–∏: {{ error_code }}
            {% endif %}

      - service: notify.zapgroup
        data:
          title: "{{ error_title }}"
          message: >
            {{ error_message }}

            –¢–µ–∫—É—â–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å: {{ states('sensor.sensor_eva_humidity') }}%
            –¶–µ–ª–µ–≤–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å: {{ states('sensor.adaptive_target_humidity') }}%